<!DOCTYPE html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Rails Tutorial &#183; Devise with MongoDB and Mongoid &#183; RailsApps</title>
  <meta name="viewport" content="width=device-width">
  <link href="https://plus.google.com/117374718581973393536" rel="publisher">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.2.2/css/normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.2.2/css/foundation.min.css">
  <link rel="stylesheet" href="http://railsapps.github.io/css/railsapps.css" />
  <link rel="stylesheet" href="http://railsapps.github.io/css/syntax.css" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="http://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
  window.analytics=window.analytics||[],window.analytics.methods=["identify","group","track","page","pageview","alias","ready","on","once","off","trackLink","trackForm","trackClick","trackSubmit"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var key=window.analytics.methods[i];window.analytics[key]=window.analytics.factory(key)}window.analytics.load=function(t){if(!document.getElementById("analytics-js")){var a=document.createElement("script");a.type="text/javascript",a.id="analytics-js",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.io/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)}},window.analytics.SNIPPET_VERSION="2.0.9",
    window.analytics.load("l1stqfqqbf");
    window.analytics.page();
    window.analytics.ready(function () {
      ga('require', 'linker');
      ga('linker:autoLink', ['railscomposer.com','learn-rails.com','blog.railsapps.org','tutorials.railsapps.org']);
    });
    </script>
</head>
<body>
  <div class="fixed">
    <nav class="top-bar" data-topbar>
      <ul class="title-area">
        <li class="name">
          <a href="http://railsapps.github.io/" class="brand">RailsApps Project</a>
        </li>
        <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
      </ul>
      <section class="top-bar-section">
        <ul class="right">
          <li><a href="https://tutorials.railsapps.org/" class="google">Tutorials</a></li>
          <li><a href="http://twitter.com/rails_apps" class="twitter">Twitter</a></li>
          <li><a href="http://blog.railsapps.org/" class="twitter">Blog</a></li>
          <li><a href="https://github.com/RailsApps" class="github">GitHub Repository</a></li>
        </ul>
      </section>
    </nav>
  </div>
  <div class="row">
    <div class="large-12 columns">
      <div class="content wikistyle gollum textile">
        h1. Rails Tutorial for Devise with Mongoid

h4. by Daniel Kehoe

_Last updated 19 August 2012_

Ruby on Rails tutorial showing how to create a Rails 3.2 application using *Devise* with *Mongoid*.

"Devise":https://github.com/plataformatec/devise gives you ready-made authentication and user management. "Mongoid":http://mongoid.org/ gives access to a MongoDB datastore for quick development without schemas or migrations.  This tutorial also gives you the option of using jQuery, Haml, RSpec and Cucumber, showing how to integrate each option.

h4. Similar Examples and Tutorials

|_. Author |_. Example App |_. Comments |
| Plataformatec | "Devise":https://github.com/plataformatec/devise_example | Simple example using SQLite |
| Daniel Kehoe | "Devise, RSpec, Cucumber":https://github.com/RailsApps/rails3-devise-rspec-cucumber | Detailed tutorial, app template, starter app, using SQLite |
| Daniel Kehoe | "OmniAuth, Mongoid":https://github.com/RailsApps/rails3-mongoid-omniauth | Detailed tutorial, app template, starter app, using MongoDB |

See a list of additional "Rails examples, tutorials, and starter apps":http://railsapps.github.io/rails-examples-tutorials.html.

h2. !http://twitter-badges.s3.amazonaws.com/t_logo-a.png(Follow on Twitter)!:http://www.twitter.com/rails_apps Follow on Twitter

Follow the project on Twitter: "rails_apps":http://twitter.com/rails_apps. Tweet some praise if you like what you've found.

h2. !http://railsapps.github.io/images/rails-36x36.jpg(Tutorial)! Tutorial

This tutorial documents each step that you must follow to create this application. Every step is documented concisely, so a complete beginner can create this application without any additional knowledge. However, no explanation is offered for any of the steps, so if you are a beginner, you're advised to look for an introduction to Rails elsewhere. See recommendations for a "Rails tutorial":https://tutorials.railsapps.org/rails-tutorial and resources for getting started with "Rails":http://railsapps.github.io/rails.html.

h2. Before You Start

If you follow this tutorial closely, you'll have a working application that closely matches the example app in this GitHub repository. The example app is your reference implementation. If you find problems with the app you build from this tutorial, download the example app (in Git speak, clone it) and use a file compare tool to identify differences that may be causing errors. On a Mac, "good file compare tools":http://stackoverflow.com/questions/187064/graphical-diff-for-mac-os-x are "FileMerge":http://en.wikipedia.org/wiki/Apple_Developer_Tools#FileMerge, "DiffMerge":http://sourcegear.com/diffmerge/, "Kaleidoscope":http://www.kaleidoscopeapp.com/, or Ian Baird's "Changes":http://www.changesapp.com/.

If you clone and install the example app and find problems or wish to suggest improvements, please create a "GitHub issue":https://github.com/RailsApps/rails3-mongoid-devise/issues.

To improve this tutorial, please leave comments below.

h2. Installing MongoDB

If you don't have MongoDB installed on your computer, you'll need to install it and set it up to be always running on your computer (run at launch).

On Mac OS X, the easiest way to install MongoDB is to install "Homebrew":http://mxcl.github.com/homebrew/ and then run the following:

<pre>
brew install mongodb
</pre>

Homebrew will provide post-installation instructions to get MongoDB running. The last line of the installation output shows you the MongoDB install location (for example, */usr/local/Cellar/mongodb/1.8.0-x86_64*). You'll find the MongoDB configuration file there. After an installation using Homebrew, the default data directory will be */usr/local/var/mongodb*.

On the Debian GNU/Linux operating system, as of March 2013, the latest stable version is MongoDB 2.0.0. With MongoDB 2.0.0, the Mongoid gem must be version 3.0.x. See the "Mongoid installation instructions":http://mongoid.org/en/mongoid/docs/installation.html#installation. Change your Gemfile to use an earlier Mongoid version:

<pre>
gem 'mongoid', '~&gt; 3.0.1'
</pre>

h2. Creating the Application

You have several options for getting the code. You can _copy from the tutorial_, _fork_, _clone_, or _generate_.

h3. Copy from the Tutorial

To create the application, you can cut and paste the code from the tutorial into your own files. It's a bit tedious and error-prone but you'll have a good opportunity to examine the code closely.

h3. Fork

If you'd like to add features (or bug fixes) to improve the example application, you can fork the GitHub repo and "make pull requests":http://help.github.com/send-pull-requests/. Your code contributions are welcome!

h3. Clone

If you want to copy and customize the app with changes that are only useful for your own project, you can download or clone the GitHub repo. You'll need to search-and-replace the project name throughout the application. You probably should generate the app instead (see below).

h3. Generate

You can use the "Rails Composer":http://railsapps.github.io/rails-composer/ tool to generate a new version of the example app. You'll be able to give it your own project name when you generate the app. Generating the application gives you additional options.

To build the example application, run the command:

<pre>
$ rails new rails3-mongoid-devise -m https://raw.github.com/RailsApps/rails-composer/master/composer-Rails3_2.rb -T -O
</pre>

Use the @-T -O@ flags to skip Test::Unit files and Active Record files.

The @$@ character indicates a shell prompt; don't include it when you run the command.

This creates a new Rails app named @rails3-mongoid-devise@ on your computer. You can use a different name if you wish.

You'll see a prompt:

<pre>
question  Install an example application?
      1)  I want to build my own application
      2)  rails3-bootstrap-devise-cancan
      3)  rails3-devise-rspec-cucumber
      4)  rails3-mongoid-devise
      5)  rails3-mongoid-omniauth
      6)  rails3-subdomains
</pre>

Choose *4) rails3-mongoid-devise*.

The application generator template will ask you for additional preferences.

For this tutorial, choose "WEBrick" for your development webserver.

You can choose to set a robots.txt file to ban spiders and keep your site out of Google search results.

If you are a Linux user and you haven't installed node.js, you'll need to answer "yes" to install the 'therubyracer' JavaScript runtime.

If you have installed "rvm":https://rvm.io/, the Ruby Version Manager, I recommend you answer "yes" to the prompt, "Use or create a project-specific rvm gemset?" See the article "Installing Rails":http://railsapps.github.io/installing-rails.html to learn about the benefits of using rvm.

Finally, the program will ask if you want to create a GitHub repository.

If you get an error "You have already activated (...) but your Gemfile requires (...)", try deleting the rails3-mongoid-devise folder and running the command again.

h2. Assumptions

Before beginning this tutorial, you need to install

* The Ruby language (version 1.9.3 or newer)
* Rails 3.2

Check that appropriate versions of Ruby and Rails are installed in your development environment:

@$ ruby -v@
@$ rails -v@

Be sure to read "Installing Rails":http://railsapps.github.io/installing-rails.html for detailed instructions and advice.

h2. Create the Rails Application

Beginning here, we show how to create the application from scratch.

(This has already been done for you if you use the the "Rails Composer":http://railsapps.github.io/rails-composer/ tool.)

Open a terminal, navigate to a folder where you have rights to create files, and type:

@$ rails new rails3-mongoid-devise -T -O@

Use the @-T -O@ flags to skip Test::Unit files and Active Record files.

You may give the app a different name if you are building it for your own use. For this tutorial, we'll assume the name is "rails3-mongoid-devise."

This will create a Rails application that uses a SQLite database for data storage. We'll modify it to use MongoDB.

After you create the application, switch to its folder to continue work directly in that application:

@$ cd rails3-mongoid-devise@

h3. Edit the README

If you’re open sourcing the app on GitHub, please edit the README file to add a description of the app and your contact info. Changing the README is important if you’re using a clone of the example app. I’ve been mistaken (and contacted) as the author of apps that are copied from my example.

h2. Set Up Source Control (Git)

If you're creating an app for deployment into production, you'll want to set up a source control repository at this point. If you are building a throw-away app for your own education, you may skip this step.

@$ git init .@
@$ git add .@
@$ git commit -m 'Initial commit'@

See detailed instructions for "Git and Rails":http://railsapps.github.io/rails-git.html.

h2. Set Up Gems

h4. About Required Gems

The application uses the following gems:

* "rails":http://rubygems.org/gems/rails
* "rspec-rails":http://rubygems.org/gems/rspec-rails
* "database_cleaner":http://rubygems.org/gems/database_cleaner
* "factory_girl_rails":http://rubygems.org/gems/factory_girl_rails
* "cucumber-rails":http://rubygems.org/gems/cucumber-rails
* "capybara":http://rubygems.org/gems/capybara
* "mongoid":http://rubygems.org/gems/mongoid
* "bson_ext":http://rubygems.org/gems/bson_ext
* "devise":http://rubygems.org/gems/devise

h3. Set up Your Gemfile

It's a good idea to create a new gemset using rvm, the "Ruby Version Manager":http://rvm.beginrescueend.com/, as described in the article "Installing Rails":http://railsapps.github.io/installing-rails.html.

See "Example Gemfiles for Rails 3.2":http://railsapps.github.io/rails-3-2-example-gemfile.html.

Open your *Gemfile* and replace the contents with the following:

*Gemfile*

<pre>
source 'https://rubygems.org'
gem 'rails', '3.2.13'
group :assets do
  gem 'sass-rails',   '~&gt; 3.2.3'
  gem 'coffee-rails', '~&gt; 3.2.1'
  gem 'uglifier', '&gt;= 1.0.3'
end
gem 'jquery-rails'
gem "mongoid", "&gt;= 3.0.3"
gem "rspec-rails", "&gt;= 2.11.0", :group =&gt; [:development, :test]
gem "capybara", "&gt;= 1.1.2", :group =&gt; :test
gem "database_cleaner", "&gt;= 0.8.0", :group =&gt; :test
gem "mongoid-rspec", "&gt;= 1.4.6", :group =&gt; :test
gem "email_spec", "&gt;= 1.2.1", :group =&gt; :test
gem "cucumber-rails", "&gt;= 1.3.0", :group =&gt; :test, :require =&gt; false
gem "launchy", "&gt;= 2.1.2", :group =&gt; :test
gem "factory_girl_rails", "&gt;= 4.0.0", :group =&gt; [:development, :test]
gem "devise", "&gt;= 2.1.2"
</pre>

Check for the "current version of Rails":http://rubygems.org/gems/rails and replace @gem 'rails', '3.2.13'@ accordingly.

_Note:_ The RailsApps examples are generated with application templates created by the "Rails Apps Composer Gem":https://github.com/RailsApps/rails_apps_composer. For that reason, groups such as @:development@ or @:test@ are specified inline. You can reformat the Gemfiles to organize groups in an eye-pleasing block style. The functionality is the same.

h3. Install the Required Gems

When you add a new gem to the Gemfile, you should run the @bundle install@ command to install the required gems on your computer. Run:

<pre>
bundle install
</pre>

You can check which gems are installed on your computer with:

<pre>
$ gem list
</pre>

Keep in mind that you have installed these gems locally. When you deploy the app to another server, the same gems (and versions) must be available.

h2. Haml

In this tutorial, we'll use the default "ERB" Rails template engine. Optionally, you can use another template engine, such as Haml. See instructions for "Haml and Rails":http://railsapps.github.io/rails-haml.html.

h2. Adding RSpec for Unit Testing

bq. +If you are creating an application template, this step uses the "rspec":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/rspec.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


You don't have to install RSpec. The example app will run without it. However, if you are planning to use the example app as a starter app for futher development, you really should install RSpec. RSpec is generally preferred to the Rails default TestUnit for unit testing.

The "RSpec Book":http://www.pragprog.com/titles/achbd/the-rspec-book is the best reference for using RSpec.

h4. Install RSpec and Related Gems

Use the gem "rspec-rails":https://github.com/rspec/rspec-rails to set up the app for RSpec.

Add the following to your *Gemfile* file:

<pre>
gem 'rspec-rails', :group =&gt; [:development, :test]
gem 'database_cleaner', :group =&gt; :test
gem 'factory_girl_rails', :group =&gt; :test
gem 'mongoid-rspec', :group =&gt; :test
</pre>

The gem @rspec-rails@ needs to be in the @:development@ group (as well as the @:test@ group) to expose generators and rake tasks during development.

The gems mongoid-rspec and factory_girl_rails add additional capabilities (described below).

Install the required gems on your computer:

@$ bundle install@

h4. Generate RSpec

Use the rspec-rails generator to set up files needed for RSpec:

@$ rails generate rspec:install@

You can remove the *test* folder (it is not needed for RSpec):

@$ rm -rf test/@

You can also modify the *config/application.rb* file to remove the following:

<pre>
require 'rails/test_unit/railtie'
</pre>

h4. Suppress Spec Tests for Views and Helpers

When RSpec is installed, Rails generators create specs for views and helpers when the @rails generate controller@ or @rails generate scaffold@ commands are run. If you don't want specs for views and helpers, modify the *config/application.rb* file to add the following:

<pre>
class Application 

h4. Remove ActiveRecord artifacts

To use Mongoid with RSpec, you'll need to remove ActiveRecord artifacts from the *spec/spec_helper.rb* file. Modify the file to comment out or remove:

<pre>
# config.fixture_path = "#{::Rails.root}/spec/fixtures"
# config.use_transactional_fixtures = true
</pre>

Without this adjustment, when you run @rake spec@ with spec files that contain @require 'spec_helper'@ you'll get an error @undefined method `fixture_path='@.

h4. Database Cleaner for RSpec

RSpec needs to reset the database during testing. You'll need to configure RSpec to inform Database Cleaner that you are using Mongoid.

Modify the file *spec/spec_helper.rb* to add this:

<pre>
RSpec.configure do |config|
  # Other things

  # Clean up the database
  require 'database_cleaner'
  config.before(:suite) do
    DatabaseCleaner.strategy = :truncation
    DatabaseCleaner.orm = "mongoid"
  end

  config.before(:each) do
    DatabaseCleaner.clean
  end
end
</pre>

h4. Add RSpec Matchers for Mongoid

Matchers provide ready-made code for your specs, allowing you to quickly add tests for common features. If you are writing specs for ORM features such as validation in Rails models, you will need matchers customized for RSpec and Mongoid. Two similar gems are available: "mongoid-rspec":https://github.com/evansagge/mongoid-rspec and "remarkable_mongoid":https://github.com/bcardarella/remarkable_mongoid. We use mongoid-rspec in this example. You'll need @gem 'mongoid-rspec', :group =&gt; :test@ in your Gemfile.

Create a file *spec/support/mongoid.rb*:

<pre>
RSpec.configure do |config|
  config.include Mongoid::Matchers
end
</pre>

Now you can use the "RSpec matchers for Mongoid":https://github.com/evansagge/mongoid-rspec when you write tests. Keep in mind that it may be worthwhile to test validations using ORM matchers but testing of associations is often redundant because Mongoid is well-tested. In general, it is preferable to use Cucumber scenarios to test higher-level functionality and reduce dependency on a specific ORM ("see a discussion":http://stackoverflow.com/questions/5189384/which-gem-for-rspec-matchers-should-i-use-with-mongoid).

h4. Add Factory Girl for Test Objects

The Factory Girl gem is used to create default model objects for tests. For example, if a controller action requires finding a User object before displaying a "show" page, Factory Girl will create a user just for a test of the controller. You'll need @gem 'factory_girl_rails', :group =&gt; :test@ in your Gemfile.

You'll need a *spec/factories.rb* file to contain the factory definitions for any default objects used for testing. The example "spec directory":https://github.com/RailsApps/rails3-mongoid-devise/tree/master/spec contains an implementation.

h4. Add Devise Test Helpers

Using Devise, your controllers will often include @before_filter :authenticate_user!@ to limit access to signed-in users. Your tests will fail unless a default user is created and logs in before each test runs. Devise provides test helpers to make it simple to create and log in a default user.

Create a file *spec/support/devise.rb*:

<pre>
RSpec.configure do |config|
  config.include Devise::TestHelpers, :type =&gt; :controller
end
</pre>

Now you can write controller specs that set up a signed-in user before tests are run.

h4. Run RSpec

Run @rake -T@ to check that rake tasks for RSpec are available.

You should be able to run @rake spec@ to run all specs. If you haven't written any specs, you'll see the message "No examples matching ./spec/**/*_spec.rb could be found".

You can copy the files from the example "spec directory":https://github.com/RailsApps/rails3-mongoid-devise/tree/master/spec to use our ready-made specs. If you run @rake spec@ after adding our ready-made specs, you'll see an error such as @Uninitialized constant ... (NameError)@ because you haven't created models or controllers. You'll have to complete the tutorial before @rake spec@ will run successfully.

h2. Add Cucumber for Behavior Driven Development

bq. +If you are creating an application template, this step uses the "cucumber":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/cucumber.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+

It's not necessary to add Cucumber (the example will run without it). However, it's a recommended practice to specify use cases ("user stories") as Cucumber scenarios. It's a good way to plan development and, using Cucumber, you'll have specifications for automated acceptance testing.

This tutorial shows how to set up Cucumber with Devise.

h4. Cucumber Gems

Use the gem "cucumber-rails":https://github.com/aslakhellesoy/cucumber-rails to set up the app for Cucumber.

You should have the following gems in your *Gemfile* file:

<pre>
group :test do
  gem 'cucumber-rails'
  gem 'capybara'
  gem 'database_cleaner'
end
</pre>

Install the required gems on your computer:

@$ bundle install@

Use the cucumber-rails generator to set up files needed for Cucumber:

@$ rails generate cucumber:install --capybara --rspec --skip-database@

The @-–capybara@ option specifies Capybara instead of the default Webrat for acceptance testing. The @-–rspec@ option enables RSpec matchers for your step definitions. If you used the @-O@ flag when you generated the application, the @--skip-database@ option will allow the Cucumber generator to proced without a *database.yml* file.

h4. Database Cleaner for Cucumber

To reset your application database to a pristine state during testing, Cucumber makes use of "Database Cleaner":https://github.com/bmabey/database_cleaner. You'll need to configure Cucumber to inform Database Cleaner that you are using Mongoid.

Modify the file *features/support/env.rb* like this:

<pre>
begin
  DatabaseCleaner.orm = 'mongoid'
  DatabaseCleaner.strategy = :truncation
rescue NameError
  raise "You need to add database_cleaner to your Gemfile (in the :test group) if you wish to use it."
end
</pre>

h4. Run Cucumber

Run @rake -T@ to check that rake tasks for Cucumber are available.

You should be able to run @rake cucumber@ (or more simply, @cucumber@) to run all Cucumber scenarios and steps. If you haven't written any Cucumber scenarios and steps, you'll see the message "0 scenarios, 0 steps".

h4. Write Cucumber Scenarios

To learn more about using Cucumber, refer to "The Cucumber Book":http://pragprog.com/book/hwcuc/the-cucumber-book or the free introduction to Cucumber, "The Secret Ninja Cucumber Scrolls":http://cuke4ninja.com/.

There are two approaches to writing Cucumber scenarios. The newest (and recommended) approach uses "Capybara":https://github.com/jnicklas/capybara to write the code ("steps") that turn Cucumber scenarios into executable specifications. Older versions of Cucumber provided a @web_steps.rb@ file that implemented common features. See the "The Training Wheels Came Off":http://aslakhellesoy.com/post/11055981222/the-training-wheels-came-off by Aslak Hellesøy to understand why the @web_steps.rb@ approach is no longer recommended.

h2. Use Mongoid

bq. +If you are creating an application template, this step uses the "mongoid":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/mongoid.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


Mongoid provides access to the MongoDB database from Rails.

You may want to check the current instructions for "installing Mongoid":http://mongoid.org/docs/installation.html.

Set up Mongoid with:

@$ rails generate mongoid:config@

You can use the default Mongoid configuration found in the file *config/mongoid.yml*.

The Mongoid generator automatically modifies the *config/application.rb* file to use Mongoid instead of the default ActiveRecord.

It will replace the line:

@require 'rails/all'@

with:

<pre>
require "action_controller/railtie"
require "action_mailer/railtie"
require "active_resource/railtie"
</pre>

If you are using RSpec, you don't need the following. Be sure to comment it out unless you are using the default Test::Unit.

<pre>
# require "rails/test_unit/railtie"
</pre>

Now you can safely remove the file *config/database.yml*.

Note that it is no longer necessary (as of "9 June 2010":https://github.com/mongoid/mongoid/commit/87718c30bc5e6ef69e1f78d704a5b386dd91b3eb) to modify *config/application.rb* for Mongoid. The necessary changes to the Rails generators are handled by the Mongoid gem. When you generate a model, Rails will generate a Mongoid Document.

h4. Test the App

You can check that your app runs properly by entering the command

@$ rails server@

To see your application in action, open a browser window and navigate to "http://localhost:3000/":http://localhost:3000. You should see the Rails default information page.

Stop the server with Control-C.

h2. Configure ActionMailer

bq. +If you are creating an application template, this step uses the "action_mailer":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/action_mailer.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


In its default configuration, Devise sends email messages to confirm new users and reset passwords. You'll want to configure ActionMailer to show errors during development and suppress failures when the app is deployed to production.

Set up action_mailer in your development environment in the file

*config/environments/development.rb*

by commenting out the line in the file:

<pre>
# Don't care if the mailer can't send
# config.action_mailer.raise_delivery_errors = false
</pre>

and adding:

<pre>
# ActionMailer Config
config.action_mailer.default_url_options = { :host =&gt; 'localhost:3000' }
# A dummy setup for development - no deliveries, but logged
config.action_mailer.delivery_method = :smtp
config.action_mailer.perform_deliveries = false
config.action_mailer.raise_delivery_errors = true
config.action_mailer.default :charset =&gt; "utf-8"
</pre>

Set up action_mailer in your production environment in the file

*config/environments/production.rb*

by adding:

<pre>
config.action_mailer.default_url_options = { :host =&gt; 'yourhost.com' }
# ActionMailer Config
# Setup for production - deliveries, no errors raised
config.action_mailer.delivery_method = :smtp
config.action_mailer.perform_deliveries = true
config.action_mailer.raise_delivery_errors = false
config.action_mailer.default :charset =&gt; "utf-8"
</pre>

h2. Set Up Authentication

h4. Set Up Configuration for Devise

bq. +If you are creating an application template, this step uses the "devise":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/devise.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


This app uses Devise for user management and authentication. Devise is at "https://github.com/plataformatec/devise":https://github.com/plataformatec/devise.

We've already installed the Devise gem with the @$ bundle install@ command. Run the generator:

@$ rails generate devise:install@

which installs a configuration file:

*config/initializers/devise.rb*

and a localization file.

Devise will recognize that you already have Mongoid installed and it will set its ORM configuration in the *config/initializers/devise.rb* file to include:

@require 'devise/orm/mongoid'@

h4. Generate a Model and Routes for Users

Devise can manage users and administrators separately, allowing two (or more) roles to be implemented differently. For this example, we just implement Users.

Use Devise to generate models and routes for a User:

<pre>
$ rails generate devise User
</pre>

Devise will recognize that Mongoid is installed and set up the User model with

<pre>
include Mongoid::Document
</pre>

which must precede all other statements in the model.

Devise will modify the *config/routes.rb* file to add:

<pre>
devise_for :users
</pre>

which provides a complete set of routes for user signup and login. If you run @rake routes@ you can see the routes that this line of code creates.

h4. Accommodate Cucumber Testing for "Sign Out"

By default, Devise uses an http DELETE request for sign out requests (@destroy_user_session_path@). Rails uses Javascript to implement http DELETE requests. Prior to Devise 1.4.1 (27 June 2011), Devise used an http GET request for sign out requests. Jose Valim explained the change: "GET requests should not change the state of the server. When sign out is a GET request, CSRF can be used to sign you out automatically and things that preload links can eventually sign you out by mistake as well."

However, Cucumber wants to test GET requests not DELETE requests. If you intend to use Cucumber with Devise, you must change the Devise default from DELETE to GET in *config/initializers/devise.rb* for the Rails test environment. You may see a suggestion elsewhere to tweak the routes.rb file or change the log_out link to make the fix. It isn't necessary if you change the *config/initializers/devise.rb* file.

<pre>
# The default HTTP method used to sign out a resource. Default is :delete.
config.sign_out_via = Rails.env.test? ? :get : :delete
</pre>

Since you only use Cucumber during testing, switching the default is only needed for testing.

If you're not going to use Cucumber, leave Devise's new default (DELETE) in place.

h4. Prevent Logging of Passwords

We don't want passwords written to our log file. In Rails 2, we would change the file

*app/controllers/application_controller.rb*

to include:

@filter_parameter_logging :password, :password_confirmation@

In Rails 3, this is deprecated and instead we modify the file *config/application.rb* to include:

@config.filter_parameters += [:password, :password_confirmation]@

Note that filter_parameters is an array.

h2. Customize the Application

h4. Enable Users to Have Names

bq. +If you are creating an application template, this step uses the "add_user":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/add_user.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


By default, Devise uses an email address to identify users. We'll add a "name" attribute as well.

We're using Mongoid so there is no need to set up migration files as we would with MySQL or SQLite.

We'll modify the user model to allow a "name" to be included when adding or updating a record.

You'll also want to prevent malicious hackers from creating fake web forms that would allow changing of passwords through the mass-assignment operations of update_attributes(attrs) and new(attrs). With the default Rails ActiveRecord, Devise adds

<pre>
attr_accessible :email, :password, :password_confirmation, :remember_me
</pre>

You'll need to add this yourself when using Mongoid.

Modify the file *models/user.rb* and add:

<pre>
field :name
validates_presence_of :name
validates_uniqueness_of :name, :email, :case_sensitive =&gt; false
attr_accessible :name, :email, :password, :password_confirmation, :remember_me
</pre>

This will allow users to be created (or edited) with a name attribute. When a user is created, a name and email address must be present and must be unique (not used before). Note that Devise (by default) will check that the email address and password are not blank.

h4. Create Customized Views for User Registration (ERB)

Devise provides a controller and views for registering users. It is called the "registerable" module. The controller and views are hidden in the Devise gem so we don't need to create anything. However, because we want our users to provide a name when registering, we will create custom views for creating and editing a user. Our custom views will override the Devise gem defaults.

First, to copy all the default Devise views to your application, run

@rails generate devise:views@

This will generate a set of views in the directory *app/views/devise/*.

Next, modify the views to create and edit users.

Add the following code to each file:

*app/views/devise/registrations/edit.html.erb*

<pre>
  <p><br>
  </p>
</pre>

*app/views/devise/registrations/new.html.erb*

<pre>
  <p><br>
  </p>
</pre>

We do not need to add a controller with methods to create a new user or edit or delete a user. We use the existing "registerable" module from Devise which provides a controller with methods to create, edit or delete a user.

Note that Devise's default behaviour allows any logged-in user to edit or delete his or her own record (but no one else's). When you access the edit page you are editing just your info, and not info of other users.

h4. Create Customized Views for User Registration (Haml)

If you are using Haml, Devise does not generate views for Haml (it did before February 15, 2011; see "Devise issue 878":https://github.com/plataformatec/devise/issues/878).

You can create the files:

*app/views/devise/registrations/edit.html.haml*

<pre>
%h2
  Edit #{resource_name.to_s.humanize}
= form_for(resource, :as =&gt; resource_name, :url =&gt; registration_path(resource_name), :html =&gt; { :method =&gt; :put }) do |f|
  = devise_error_messages!
  %p
    = f.label :name
    %br/
    = f.text_field :name
  %p
    = f.label :email
    %br/
    = f.email_field :email
  %p
    = f.label :password
    %i (leave blank if you don't want to change it)
    %br/
    = f.password_field :password
  %p
    = f.label :password_confirmation
    %br/
    = f.password_field :password_confirmation
  %p
    = f.label :current_password
    %i (we need your current password to confirm your changes)
    %br/
    = f.password_field :current_password
  %p= f.submit "Update"
%h3 Cancel my account
%p
  Unhappy? #{link_to "Cancel my account", registration_path(resource_name), :confirm =&gt; "Are you sure?", :method =&gt; :delete}.
= link_to "Back", :back
</pre>

*app/views/devise/registrations/new.html.haml*

<pre>
%h2 Sign up
= form_for(resource, :as =&gt; resource_name, :url =&gt; registration_path(resource_name)) do |f|
  = devise_error_messages!
  %p
    = f.label :name
    %br/
    = f.text_field :name
  %p
    = f.label :email
    %br/
    = f.email_field :email
  %p
    = f.label :password
    %br/
    = f.password_field :password
  %p
    = f.label :password_confirmation
    %br/
    = f.password_field :password_confirmation
  %p= f.submit "Sign up"
= render :partial =&gt; "devise/shared/links"
</pre>

h2. Create a Home Page

bq. +If you are creating an application template, this step uses the "home_page":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/home_page.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


h4. Remove the Default Home Page

Delete the default home page from your application:

@$ rm public/index.html@

h4. Create a Home Controller and View

Create the first page of the application. Use the Rails generate command to create a "home" controller and a "views/home/index" page.

@$ rails generate controller home index@

If you're using the default template engine, you'll find an *erb* file with placeholder content:

*app/views/home/index.html.erb*

If you're using Haml, you'll find a *haml* file with placeholder content:

*app/views/home/index.html.haml*

We'll assume you're using the default template engine for the remainder of this tutorial.

Now, you have to set a route to your home page. Edit the file *config/routes.rb* and replace:

@get "home/index"@

with

@root :to =&gt; "home#index"@

We'll add some content to the home page in the next step.

h4. Test the App

You can check that your app runs properly by entering the command

@$ rails server@

To see your application in action, open a browser window and navigate to "http://localhost:3000/":http://localhost:3000. You should see your new home page.

Stop the server with Control-C.

h2. Create a Default User

h4. Display Users on the Home Page

bq. +If you are creating an application template, this step uses the "home_page_users":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/home_page_users.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


Modify the file *app/controllers/home_controller.rb* and add @users = User.all@ to the @index@ method:

<pre>
def index
  @users = User.all
end
</pre>

Modify the file *app/views/home/index.html.erb* and add:

<pre>
<h3>Home</h3>

  <p>User:  </p>

</pre>

h4. Set Up a Database Seed File

You'll want to set up a default user so you can test the app. Modify the file *db/seeds.rb* by adding:

<pre>
puts 'SETTING UP DEFAULT USER LOGIN'
user = User.create! :name =&gt; 'First User', :email =&gt; 'user@example.com', :password =&gt; 'please', :password_confirmation =&gt; 'please'
puts 'New user created: '  'Second User', :email =&gt; 'user2@example.com', :password =&gt; 'please', :password_confirmation =&gt; 'please'
puts 'New user created: ' 

You can change the values for name, email, and password as you wish.

h4. Seed the Database

Create indexes for the database with:

<pre>
$ rake db:mongoid:create_indexes
</pre>

Add the default users to the MongoDB database by running the command:

<pre>
$ rake db:seed
</pre>

If the task fails with "Validation failed: Name can't be blank" you should check that the file *models/user.rb* allows the "name" attribute to be mass updated:

<pre>
attr_accessible :name, :email, :password, :password_confirmation, :remember_me
</pre>

During testing, if you wish to reset the MongoDB database you can run the command:

<pre>
$ rake db:drop
</pre>

Be sure to recreate the idnexes after dropping the database.

If you're not using "rvm":https://rvm.io/, you should preface each rake command with @bundle exec@. You don't need to use @bundle exec@ if you are using rvm version 1.11.0 or newer.

h4. Test the App

At this point, you may want to know if the default user has been saved to the MongoDB database.

You can check that your app runs properly by entering the command

@$ rails server@

To see your application in action, open a browser window and navigate to "http://localhost:3000/":http://localhost:3000. You should see your new home page.

Stop the server with Control-C.

h2. Set Up a Demonstration of Devise

You'll want to see how Devise manages authentication.

h4. Set Up the Users Controller, Views, and Routes

bq. +If you are creating an application template, this step uses the "users_page":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/users_page.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


Use the Rails generate command to create a "users" controller and a "views/user/show" page.

@$ rails generate controller users show@

Note that "users" is plural when you create the controller.

Modify the file *app/controllers/users_controller.rb* and add:

<pre>
before_filter :authenticate_user!

def show
  @user = User.find(params[:id])
end
</pre>

The file *config/routes.rb* has already been modified to include:

@get "users/show"@

Remove that and change the routes to:

<pre>
root :to =&gt; "home#index"
devise_for :users
resources :users
</pre>

Important note: The @devise_for :users@ route must be placed above @resources :users@.

Modify the file *app/views/users/show.html.erb* and add:

<pre>
<p>User: </p>
</pre>

h4. Add Links to Users on the Home Page

You've already modifed the file *app/controllers/home_controller.rb* to include this:

<pre>
def index
  @users = User.all
end
</pre>

Now modify the file *app/views/home/index.html.erb* to look like this:

<pre>
<h3>Home</h3>

  <p>User: </p>

</pre>

h2. Create an Application Layout

h4. Set Up CSS Stylesheets

_If you are creating an application template, this step uses the "html5":https://raw.github.com/RailsApps/rails_apps_composer/master/recipes/html5.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository_

We'll create a very simple stylesheet with styling for a horizontal menu and flash messages.

Rename the *app/assets/stylesheets/application.css* file as *app/assets/stylesheets/application.css.scss*.

Add stylesheet rules to the *application.css.scss* file:

<pre>
header nav ul {
  list-style: none;
  margin: 0 0 2em;
  padding: 0;
}
header nav ul li {
  display: inline;
}
#flash_notice, #flash_alert {
  padding: 5px 8px;
  margin: 10px 0;
}
#flash_notice {
  background-color: #CFC;
  border: solid 1px #6C6;
}
#flash_alert {
  background-color: #FCC;
  border: solid 1px #C66;
}
</pre>

h4. The Default Application Layout

bq. +If you are creating an application template, this step uses the "application_layout":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/application_layout.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+

Rails will use the layout defined in the file *app/views/layouts/application.html.erb* or *app/views/layouts/application.html.haml* as a default for rendering any page.

You'll want to include flash messages for errors and notifications. Set up your application layout by modifying the default as described in the instructions for the "Rails default application layout":http://railsapps.github.io/rails-default-application-layout.html.

h4. Add Devise Navigation Links

bq. +If you are creating an application template, this step uses the "navigation":https://raw.github.com/RailsApps/rails_apps_composer/master/recipes/navigation.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+


You will want to add navigation links to the application layout for the Devise sign-up and log-in actions. You'll find a simple example on the "Devise wiki":https://github.com/plataformatec/devise/wiki/How-To:-Add-sign_in,-sign_out,-and-sign_up-links-to-your-layout-template.

Create a *shared* directory under *app/views/*. Then create the file *app/views/shared/_navigation.html.erb* and add:

<pre>

  </pre></pre></pre><li>
  'delete') %&gt;
  </li>

  <li>
  
  </li>


  <li>
  
  </li>

  <li>
  
  </li>



Then use these partials in your *app/views/layouts/application.html.erb* file, like this:

<pre>

  </pre><ul class="hmenu">
    
  </ul>
  
    
       "flash_#{name}" %&gt;
    
  



For Haml, modify *app/views/layouts/application.html.haml* like this:

<pre>
%body
  %ul.hmenu
    = render 'shared/navigation'
  - flash.each do |name, msg|
    - if msg.is_a?(String)
      = content_tag :div, msg, :id =&gt; "flash_#{name}"
  = yield
</pre>

h2. Cleanup

Several unneeded files are generated in the process of creating a new Rails application.

Additionally, you may want to prevent search engines from indexing your website if you've deployed it publicly while still in development.

See instructions for "cleaning up unneeded files in Rails and banning spiders":http://railsapps.github.io/rails-cleanup.html.

h4. Remove Unneeded Files

bq. +If you are creating an application template, this step uses the "cleanup":https://github.com/RailsApps/rails_apps_composer/raw/master/recipes/cleanup.rb recipe from the "rails_apps_composer":https://github.com/RailsApps/rails_apps_composer repository.+

h2. Test the App

You can check that your app runs properly by entering the command

@$ rails server@

To see your application in action, open a browser window and navigate to "http://localhost:3000/":http://localhost:3000. You should see the default user listed on the home page. When you click on the user's name, you should be required to log in before seeing the user's detail page.

Stop the server with Control-C.

h2. Deploy to Heroku

For your convenience, here are "instructions for deploying your app to Heroku":http://railsapps.github.io/rails-heroku-tutorial.html. Heroku provides low cost, easily configured Rails application hosting.

h2. Conclusion

This concludes the tutorial for creating a Ruby on Rails web application that requires Rails 3 and uses Mongoid for data storage and Devise for user management and authentication.

h4. Credits

Daniel Kehoe ("http://danielkehoe.com/":http://danielkehoe.com/) implemented the application and wrote the tutorial.

Was this useful to you? Follow me on Twitter:
"rails_apps":http://twitter.com/rails_apps
and tweet some praise. I'd love to know you were helped out by the tutorial.

Any issues? Please create an "Issue":https://github.com/RailsApps/rails3-mongoid-devise/issues on GitHub.

h4. Contributors

Thank you for improvements to the tutorial by contributors "Cory Foy":https://github.com/CoryFoy, "Luca G. Soave":https://github.com/lgs, "Bob Clewell":https://github.com/bobclewell, and "Justin Workman":https://github.com/xtagon.

      </div>
      <div class="comments" id="comments">
        <div class="content wikistyle gollum">
          <h2>Comments</h2>
        </div>
        <p>Is this helpful? Your encouragement fuels the project. Please tweet or add a comment. Couldn't get something to work? For the example apps and tutorials, it's best to open an issue on GitHub so we can help you.</p>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'railsapps'; // required: replace example with your forum shortname
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div><!-- class="comments" -->
    </div><!-- class="columns" -->
  </div><!-- class="row" -->
  <footer class="row">
    <div class="large-12 columns">
      <div class="row">
         <div class="medium-4 large-4 columns">
           <dl class="footer_nav">
             <dt>RailsApps &#183; Getting Started</dt>
             <dd><a href="http://railsapps.github.io/ruby-and-rails.html">Ruby on Rails</a></dd>
             <dd><a href="http://railsapps.github.io/what-is-ruby-rails.html">What is Ruby on Rails?</a></dd>
             <dd><a href="http://learn-rails.com/learn-ruby-on-rails.html">Learn Ruby on Rails</a></dd>
             <dd><a href="https://tutorials.railsapps.org/rails-tutorial">Rails Tutorial</a></dd>
             <dd><a href="http://learn-rails.com/ruby-on-rails-tutorial-for-beginners">Ruby on Rails Tutorial for Beginners</a></dd>
             <dd><a href="http://railsapps.github.io/installing-rails.html">Install Ruby on Rails</a></dd>
             <dd><a href="http://railsapps.github.io/installrubyonrails-mac.html">Install Ruby on Rails - Mac OS X</a></dd>
             <dd><a href="http://railsapps.github.io/installrubyonrails-ubuntu.html">Install Ruby on Rails - Ubuntu</a></dd>
             <dd><a href="http://railsapps.github.io/rubyonrails-nitrous-io.html">Ruby on Rails - Nitrous.io</a></dd>
             <dd><a href="http://railsapps.github.io/updating-rails.html">Update Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-composer/">Rails Composer</a></dd>
             <dd><a href="http://railsapps.github.io/">Rails Examples</a></dd>
             <dd><a href="http://railsapps.github.io/rails-examples-tutorials.html">Rails Starter Apps</a></dd>
           </dl>
         </div>
         <div class="medium-4 large-4 columns">
           <dl class="footer_nav">
             <dt>RailsApps &#183; Articles</dt>
             <dd><a href="http://railsapps.github.io/rails-authorization.html">Rails Authorization</a></dd>
             <dd><a href="http://railsapps.github.io/rails-google-analytics.html">Analytics for Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-heroku-tutorial.html">Heroku and Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-javascript-include-external.html">JavaScript and Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-environment-variables.html">Rails Environment Variables</a></dd>
             <dd><a href="http://railsapps.github.io/rails-git.html">Git and Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-github.html">Rails GitHub</a></dd>
             <dd><a href="http://railsapps.github.io/rails-send-email.html">Send Email with Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-haml.html">Haml and Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-default-application-layout.html">Rails Application Layout</a></dd>
             <dd><a href="http://railsapps.github.io/rails-html5-boilerplate.html">HTML5 Boilerplate for Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-3-2-example-gemfile.html">Example Gemfiles for Rails</a></dd>
             <dd><a href="http://railsapps.github.io/rails-application-templates.html">Rails Application Templates</a></dd>
             <dd><a href="http://railsapps.github.io/rails-product-planning.html">Rails Product Planning</a></dd>
             <dd><a href="http://railsapps.github.io/rails-project-management.html">Rails Project Management</a></dd>
           </dl>
           </div>
           <div class="medium-4 large-4 columns">
           <dl class="footer_nav">
             <dt>RailsApps &#183; Tutorials</dt>
             <dd><a href="http://railsapps.github.io/twitter-bootstrap-rails.html">Rails Bootstrap</a></dd>
             <dd><a href="http://railsapps.github.io/rails-foundation.html">Rails Foundation</a></dd>
             <dd><a href="http://railsapps.github.io/rails-omniauth/">OmniAuth Tutorial</a></dd>
             <dd><a href="http://railsapps.github.io/tutorial-rails-devise.html">Rails Devise Tutorial</a></dd>
             <dd><a href="http://railsapps.github.io/tutorial-rails-devise-rspec-cucumber.html">Devise RSpec</a></dd>
             <dd><a href="http://railsapps.github.io/tutorial-rails-bootstrap-devise-cancan.html">Devise Bootstrap</a></dd>
             <dd><a href="http://railsapps.github.io/rails-devise-roles">Role-Based Authorization</a></dd>
             <dd><a href="http://railsapps.github.io/rails-devise-pundit">Rails Authorization with Pundit</a></dd>
             <dd><a href="https://tutorials.railsapps.org/rails-stripe-membership-saas">Rails Membership Site with Stripe</a></dd>
             <dd><a href="https://tutorials.railsapps.org/rails-recurly-subscription-saas">Rails Subscription Site with Recurly</a></dd>
             <dd><a href="https://tutorials.railsapps.org/rails-prelaunch-signup">Startup Prelaunch Signup Application</a></dd>
           </dl>
           <dl class="footer_nav">
            <dt>RailsApps Profile</dt>
            <dd><a href="https://plus.google.com/108039160165742774777?rel=author">Google</a></dd>
            <dd><a href="https://plus.google.com/117374718581973393536" rel="publisher">Find us on Google+</a></dd>
           </dl>
        </div>
      </div>
    </div>
  </footer>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.2.2/js/foundation.min.js"></script>
<script>
  $(document).foundation();
</script>
</body>
</html>
