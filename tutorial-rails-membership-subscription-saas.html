<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Rails Tutorial &#183; Membership Subscription or SaaS Site &#183; RailsApps</title>
    <link href="https://plus.google.com/u/0/b/117374718581973393536/117374718581973393536/posts/" rel="publisher" />
    <link rel="stylesheet" href="http://railsapps.github.com/css/bootstrap.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="http://railsapps.github.com/css/screen.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="http://railsapps.github.com/css/gollum.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="http://railsapps.github.com/css/site.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="http://railsapps.github.com/css/syntax.css" type="text/css" charset="utf-8" />
    <script src="http://code.jquery.com/jquery-1.6.min.js" type="text/javascript"></script>
    <script src="http://railsapps.github.com/javascript/jquery.text_selection-1.0.0.min.js" type="text/javascript"></script>
    <script src="http://railsapps.github.com/javascript/jquery.previewable_comment_form.js" type="text/javascript"></script>
    <script src="http://railsapps.github.com/javascript/jquery.tabs.js" type="text/javascript"></script>
    <script src="http://railsapps.github.com/javascript/gollum.js" type="text/javascript"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-5109366-14']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>

  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a href="http://railsapps.github.com/" class="brand">RailsApps Project</a>
        <ul class="pull-right nav">
          <li><a href="http://blog.railsapps.org/" class="twitter">Blog</a></li>
          <li><a href="http://twitter.com/rails_apps" class="twitter">Twitter</a></li>
          <li><a href="https://plus.google.com/117374718581973393536" class="google">Google +</a></li>
          <li><a href="https://github.com/RailsApps" class="github">GitHub Repository</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container"> 

    <div class="content wikistyle gollum textile">
      <h1>Rails Tutorial for a Membership, Subscription, or SaaS Site</h1>
<h4>by Daniel Kehoe</h4>
<p><em>Last updated 9 September 2012</em></p>
<p>Ruby on Rails tutorial for a web application with Rails recurring billing using Stripe. Use for a Rails membership, subscription, or SaaS site. Complete Rails 3.2 example application available on GitHub at  <a href="http://github.com/RailsApps/rails-membership-subscription-saas">rails-membership-subscription-saas</a> from the <a href="http://railsapps.github.com/">RailsApps Project</a>.</p>
<p><img src="http://railsapps.github.com/images/rails-prelaunch-signup.png" title="Rails Application for a Startup Prelaunch Signup Site" alt="Rails Application for a Startup Prelaunch Signup Site"></p>
<h2>
<a href="http://www.twitter.com/rails_apps"><img src="http://twitter-badges.s3.amazonaws.com/t_logo-a.png" title="Follow on Twitter" alt="Follow on Twitter"></a> Follow on Twitter</h2>
<p>Follow the project on Twitter: <a href="http://twitter.com/rails_apps">@rails_apps</a>. Tweet some praise if you like what you’ve found.</p>
<h2>Introduction</h2>
<p>Membership sites restrict access to content such as articles, videos, or user forums. Software-as-a-service (SaaS) sites limit use of web-based software to paid subscribers. The revenue model is the same whether the site provides high-value content or software as a service: A visitor purchases a subscription and is given access to restricted areas of the site. Typically, the subscription is repurchased monthly through a system that provides recurring billing.</p>
<p>If you’re planning to build a SaaS applications, a membership site, or some other subscription-based web service, your application will need the following rudimentary functionality:</p>
<ul>
<li>content or web functionality to deliver value</li>
	<li>landing pages to convert visitors to paying customers</li>
	<li>user management to register or remove users</li>
	<li>access control to limit site-wide access to authenticated users</li>
	<li>authorization management to restrict access to content or services based on role or other characteristics</li>
	<li>account management to maintain records of subscription status</li>
	<li>a recurring billing system for periodic payment transactions</li>
</ul><p>Developers have been building this type of application since soon after the web was born. This example application exists so you don’t have to build it yourself. It aims to:</p>
<ul>
<li>eliminate effort spent building an application that meets a common need;</li>
	<li>offer code that is already implemented and tested by a large community;</li>
	<li>provide a well-thought-out app containing most of the features you’ll need.</li>
</ul><p>By using code from this project, you’ll be able to:</p>
<ul>
<li>direct your attention to the design and features that make your business unique;</li>
	<li>get a fast start building and launching the application you need for your business.</li>
</ul><p>This tutorial is for experienced developers as well as startup founders or hobbyist coders who are new to Rails.</p>
<p>Experienced developers will find the complete application on GitHub; this tutorial provides the detail and background to understand the implementation in depth. For Rails beginners, this tutorial describes each step that you must follow to create the application. Every step is documented concisely, so a complete beginner can create this application without any additional knowledge. However, the tutorial assumes you’ve already been introduced to Rails, so if you are a beginner, you may be overwhelmed unless you’ve been introduced to Rails elsewhere. See resources for getting started with <a href="http://railsapps.github.com/rails.html">Rails</a>.</p>
<h3>Features</h3>
<p>The example application provides a complete and fully functional membership site.</p>
<ul>
<li>offer tiered pricing for multiple subscription plans</li>
	<li>site can offer a “free trial” subscription as well as free accounts</li>
	<li>no local credit card storage</li>
	<li>Stripe accepts credit card payments from customers in any country or currency</li>
	<li>
<span class="caps">PCI</span> compliance using the Stripe Javascript library</li>
	<li>site served over <span class="caps">SSL</span> for security</li>
	<li>Stripe handles recurring billing, retries if payment fails, and cancels if retries fail</li>
	<li>paid subscriptions are created only after a successful credit card transaction</li>
	<li>subscribers can upgrade or downgrade subscription plans</li>
	<li>subscribers can cancel subscription plans</li>
	<li>subscribers can use coupons for discounted subscriptions</li>
	<li>configurable subscription renewal period (defaults to one month)</li>
</ul><h3>What’s Not Implemented</h3>
<p>There are additional features you may want for a SaaS application, such as:</p>
<ul>
<li>Basecamp-style subdomains (each user gets their own subdomain)</li>
	<li>
<a href="http://en.wikipedia.org/wiki/Multitenancy">multitenancy</a> database segmentation</li>
</ul><h3>Building Blocks</h3>
<p>One of the strengths of Rails as a web platform are RubyGems, open source code libraries that can be integrated into any Rails project. The RailsApps project aims to provide example applications that integrate the most popular gems.</p>
<p>This application puts together these gems:</p>
<ul>
<li>
<a href="http://github.com/plataformatec/devise">Devise</a> for user management and authentication</li>
	<li>
<a href="https://github.com/ryanb/cancan">CanCan</a> with <a href="https://github.com/EppO/rolify">Rolify</a> for authorization</li>
	<li>
<a href="https://stripe.com/">Stripe</a> for recurring billing</li>
</ul><h3>Devise</h3>
<p>Devise provides authentication, a system to securely identify users, making sure the user is really who he represents himself to be.</p>
<p>We use Devise because it offers a full set of features used in more complex applications, such as recovering a user’s forgotten password or allowing users to invite friends. Should you need help in troubleshooting or customizing the implementation, you’ll be able to get help from a large community of developers using Devise.</p>
<h3>CanCan with Rolify</h3>
<p>CanCan provides a system for authorization to determine if an authenticated user should have access to secured resources. CanCan is often used to restrict access to administrative pages. This application will use CanCan to restrict access to content based on the price a user has paid for a subscription.</p>
<p>CanCan provides a mechanism for limiting access at the level of controller and controller method and expects you to set permissions based on user attributes you define. CanCan doesn’t provide default user attributes such as user roles based on subscription price; you must implement this outside of CanCan. There are many ways to implement role-based authorization for use with CanCan. For this example, we use Florent Monbillard’s Rolify gem to create a Role model, add methods to a User model, and generate a migration for a roles table.</p>
<h3>Stripe</h3>
<p>Stripe is a third-party billing service that provides an <span class="caps">API</span> and gem for integration with Rails applications. There are several other third-party billing services; Stripe is the least expensive and most popular for low-volume startups. Stripe costs 2.9% + 30¢ per successful charge, with no monthly or setup fees (see <a href="https://stripe.com/help/pricing">Stripe pricing</a>).</p>
<h3>RailsApps Examples and Tutorials</h3>
<p>This is one in a series of Rails example apps and tutorials from the <a href="http://railsapps.github.com/">RailsApps Project</a>.</p>
<p>This application is based on two simpler example apps:</p>
<ul>
<li><a href="https://github.com/RailsApps/rails3-devise-rspec-cucumber">rails3-devise-rspec-cucumber</a></li>
	<li><a href="https://github.com/RailsApps/rails3-bootstrap-devise-cancan">rails3-bootstrap-devise-cancan</a></li>
</ul><p>The first example shows how to set up Devise for user authentication. It also shows how to set up the app to use RSpec and Cucumber for testing.</p>
<p>The second example shows how to set up Devise and add CanCan and Rolify to manage access to administrative pages. It also shows how to set up Twitter Bootstrap as a front-end framework for <span class="caps">CSS</span> styling.</p>
<p>You can use this tutorial without studying these example applications; if you find you are lost, it may be helpful to look at the two simpler examples.</p>
<p>If you want to use the MongoDB datastore instead of ActiveRecord and a <span class="caps">SQL</span> database, look at the  <a href="https://github.com/RailsApps/rails3-mongoid-devise">rails3-mongoid-devise</a> example.</p>
<p>Finally, be sure to look at the <a href="https://github.com/RailsApps/rails-prelaunch-signup">rails-prelaunch-signup</a> example. It is useful if you are planning prelaunch promotion. You can quickly create a site to announce your plans and encourage visitors to enter an email address for future notification of the site’s launch.</p>
<h2>
<img src="http://railsapps.github.com/images/rails-36x36.jpg" title="Tutorial" alt="Tutorial"> The Tutorial</h2>
<p>Most of the tutorials from the RailsApps project take about an hour to complete. This tutorial is more complex; it will take you about three hours to build the complete app. (Is our estimate accurate? Please leave a comment when you are done.)</p>
<p>If you find problems or wish to suggest improvements, please create a <a href="http://github.com/RailsApps/rails-membership-subscription-saas/issues">GitHub issue</a>.</p>
<p>You’ll find a comments section at the end of the tutorial. I encourage you to offer feedback to improve this tutorial.</p>
<h2>Before You Start</h2>
<p>If you follow this tutorial closely, you’ll have a working application that closely matches the example app in the GitHub repository. The example app is your reference implementation. If you find problems with the app you build from this tutorial, download the example app (in Git speak, clone it) and use a file compare tool to identify differences that may be causing errors. On a Mac, <a href="http://stackoverflow.com/questions/187064/graphical-diff-for-mac-os-x">good file compare tools</a> are <a href="http://en.wikipedia.org/wiki/Apple_Developer_Tools#FileMerge">FileMerge</a>, <a href="http://sourcegear.com/diffmerge/">DiffMerge</a>, <a href="http://www.kaleidoscopeapp.com/">Kaleidoscope</a>, or Ian Baird’s <a href="http://www.changesapp.com/">Changes</a>. Please create a <a href="http://github.com/RailsApps/rails-membership-subscription-saas/issues">GitHub issue</a> if the repository version of the application doesn’t work as expected.</p>
<h2>Accounts You May Need</h2>
<p>Before you start, you will need accounts for <em>recurring billing</em>, <em>hosting</em>, <em>email</em>, and a <em>source control repository</em>.</p>
<h3>Billing</h3>
<p>Many providers of billing services want your business:</p>
<ul>
<li>
<a href="https://stripe.com/">Stripe</a> (2011)</li>
	<li>
<a href="http://saasy.com/">SaaSy</a> (2011)</li>
	<li>
<a href="http://recurly.com/">Recurly</a> (2010)</li>
	<li>
<a href="http://www.earlyimpact.com/subscriptionbridge/">SubscriptionBridge</a> (2010)</li>
	<li>
<a href="http://chargify.com/">Chargify</a> (2009)</li>
	<li>
<a href="https://cheddargetter.com/">CheddarGetter</a> (2009)</li>
	<li>
<a href="http://www.braintreepayments.com/">Braintree</a> (2007)</li>
	<li>
<a href="http://spreedly.com/">Spreedly</a> (2007)</li>
	<li>
<a href="http://www.zuora.com/">Zuora</a> (2007)</li>
	<li>
<a href="http://www.adyen.com/">Adyen</a> (2006)</li>
	<li>
<a href="http://www.vindicia.com/">Vindicia</a> (2003)</li>
	<li>
<a href="http://www.ariasystems.com/">Aria Systems</a> (2003)</li>
</ul><p>The list shows the year each service was founded. In general, since the market is highly competetive, the newer services are less expensive and offer better integration, interfaces, and features.</p>
<p>Several blog posts compare services and pricing:</p>
<ul>
<li>
<a href="http://blog.subscrea.com/recurring-billing/peeling-the-onion-called-recurring-billing-part-ii/">Peeling the onion called recurring billing</a> (July 2012)</li>
	<li>
<a href="http://expletiveinserted.com/2011/03/18/comparing-recurring-payment-solutions/">Comparing Recurring Payment Solutions</a> (March 2011)</li>
</ul><p>You can use a web-based calculator to compare pricing of some services:</p>
<ul>
<li><a href="http://www.billingsavvy.com/">BillingSavvy</a></li>
</ul><p>BillingSavvy shows Stripe is cheaper than Recurly for less than 600 subscribers. Over 600 subscribers, Recurly becomes cheaper. Stripe and Recurly are always cheaper than Chargify, CheddarGetter and Spreedly for $12/month subscriptions.</p>
<p>This tutorial shows to set up recurring billing using Stripe. Before you start, go to the <a href="https://stripe.com/">Stripe website</a> and set up an account. You don’t need a credit card merchant account or payment gateway. There’s no approval process to delay getting started.</p>
<h3>Hosting</h3>
<p>For easy deployment, use a “platform as a service” provider such as:</p>
<ul>
<li><a href="http://www.heroku.com/">Heroku</a></li>
	<li><a href="http://www.cloudfoundry.com/">CloudFoundry</a></li>
	<li><a href="http://www.engineyard.com/">EngineYard</a></li>
	<li><a href="https://openshift.redhat.com/app/">OpenShift</a></li>
</ul><p>Instructions are provided for deployment to Heroku.</p>
<p>It’s common for technically skilled people to want to set up their own servers. Please, do yourself a favor, and unless system administration is your most dearly loved recreation, let the platform providers do it for you.</p>
<h3>Email Service Providers</h3>
<p>You’ll need infrastructure for three types of email:</p>
<ul>
<li>company email</li>
	<li>email sent from the app (“transactional email”)</li>
	<li>broadcast email for newsletters or announcements</li>
</ul><p>No single vendor is optimal for all three types of email; you likely will use several vendors.</p>
<p>For “company email,” that is, sending individual email to customers or business associates, you’ll probably use Gmail or <a href="http://www.google.com/enterprise/apps/business/index.html">Google Apps for Business</a>. For a single address, you can set up a single Gmail account to receive and <a href="http://support.google.com/mail/bin/answer.py?hl=en&amp;ctx=mail&amp;answer=22370">send email from a different address</a>. More likely, you’ll want several email addresses for your company mail. For that, use Google Apps for Business.</p>
<h3>Transactional Email</h3>
<p>For simple testing of email, it’s easy to use Gmail to send email messages from the application. For deployment, when the application must send dozens or thousands of acknowledgments or invitations, you will need a hosted <span class="caps">SMTP</span> relay service (also known as an <span class="caps">ESP</span> or “email service provider”). Considerable expertise is required to keep email from being filtered as spam (see MailChimp’s <a href="http://mailchimp.com/resources/guides/html/email-delivery-for-it-professionals/">Email Delivery For IT Professionals</a>). Use an <span class="caps">ESP</span> to increase reliability of delivery. The best services track deliveries and show how well your email is being delivered.</p>
<p>Many of these services offer a free plan allowing up to 200 emails/day:</p>
<ul>
<li><a href="http://mandrill.com/">Mandrill by MailChimp</a></li>
	<li><a href="http://sendgrid.com/pricing.html">SendGrid</a></li>
	<li><a href="http://mailgun.net/pricing">Mailgun</a></li>
	<li><a href="http://aws.amazon.com/ses/pricing/" title="SES">Amazon Simple Email Service</a></li>
	<li><a href="http://elasticemail.com/pricing">Elastic Email</a></li>
	<li><a href="http://www.critsend.com/pricing">CritSend</a></li>
	<li><a href="https://www.mailjet.com/pricing">Mailjet</a></li>
	<li><a href="http://www.messagegears.com/">MessageGears</a></li>
	<li><a href="https://secure.postageapp.com/register">PostageApp</a></li>
	<li><a href="http://postmarkapp.com/pricing">Postmark</a></li>
	<li><a href="https://www.serversmtp.com/en/cart.php?systpl=turbo-smtp&amp;systpl=turbo-smtp&amp;currency=3">turboSMTP</a></li>
</ul><p>This tutorial provides instructions for <a href="http://mandrill.com/">Mandrill by MailChimp</a>. The Mandrill transactional email service integrates well with the MailChimp email list manager service. Plus, you can send up to 12,000 emails/month from the service for free.</p>
<p>Sign up for a MailChimp account to get started. After you’ve created your MailChimp account, see the instructions to <a href="http://help.mandrill.com/customer/portal/articles/464750-use-mandrill-with-mailchimp">Use Mandrill with MailChimp</a>. Then get the <a href="http://help.mandrill.com/customer/portal/articles/464828-access-information">Access Information</a> (your <span class="caps">SMTP</span> username and password, which is an <span class="caps">API</span> key).</p>
<h3>Mailing List</h3>
<p>In addition to sending transactional email messages, you likely will want to send newsletters or announcements to your entire mailing list. <span class="caps">SMTP</span> relay services such as SendGrid often offer rudimentary bulk email services but you may want to consider using a dedicated service for mass emailing. You’ll get features such as management of “unsubscribe” requests and templates to design attractive messages.</p>
<p>For broadcast email, consider using a service such as:</p>
<ul>
<li><a href="http://mailchimp.com/pricing/">MailChimp</a></li>
	<li><a href="https://www.madmimi.com/service_agreements/choose_plan">MadMimi</a></li>
	<li><a href="http://www.campaignmonitor.com/pricing/">CampaignMonitor</a></li>
	<li><a href="http://www.constantcontact.com/pricing/email-marketing.jsp">Constant Contact</a></li>
	<li><a href="http://www.ymlp.com/pricing.html"><span class="caps">YMLP</span></a></li>
	<li><a href="http://www.jangomail.com/pricing.asp">JangoMail</a></li>
	<li><a href="http://www.icontact.com/affordable-email-marketing">iContact</a></li>
	<li><a href="http://www.verticalresponse.com/pricing">VerticalResponse</a></li>
</ul><p>This tutorial shows how to integrate with a <a href="http://mailchimp.com/">MailChimp</a> list. MailChimp allows you to send up to 12,000 emails/month to list of 2000 or fewer subscribers for free. After you sign up for a MailChimp account, get your <span class="caps">API</span> key. Look under “Account” for “<span class="caps">API</span> Keys and Authorized Apps.” Note that the Mandrill <span class="caps">API</span> key (which you get on the <a href="http://mandrill.com/">mandrill.com</a> site) is different from the MailChimp <span class="caps">API</span> key (which you get on the <a href="http://mailchimp.com/">mailchimp.com</a> site).</p>
<h3>Domain Registration</h3>
<p>You’ve likely already selected and registered a domain name. If not, you’ll need a domain before you start sending email messages from the application. If you’re disgusted by GoDaddy, consider <a href="http://www.namecheap.com/">NameCheap</a> and other popular alternatives.</p>
<h3>GitHub</h3>
<p>Get a <a href="https://github.com/signup/free">free GitHub account</a> if you don’t already have one. You’ll need a GitHub account if you plan to deploy to Heroku. If you’re not going to use Heroku, you’ll still need to use git to manage your source code.  See <a href="http://railsapps.github.com/rails-git.html">GitHub and Rails</a> if you need more information about working with git for code source control.</p>
<h2>Assumptions</h2>
<p>Before beginning this tutorial, you need to install</p>
<ul>
<li>The Ruby language (version 1.9.3)</li>
	<li>Rails 3.2</li>
</ul><p>Check that appropriate versions of Ruby and Rails are installed in your development environment:<br><code>$ ruby -v</code><br><code>$ rails -v</code></p>
<p>Be sure to read <a href="http://railsapps.github.com/installing-rails.html">Installing Rails</a> to make sure your development environment is set up properly.</p>
<p>I recommend using <a href="https://rvm.io/">rvm</a>, the Ruby Version Manager to manage your Rails versions and create a dedicated gemset for each application you build.</p>
<h2>Creating the Application</h2>
<p>You have several options for getting the code. You can <em>copy from the tutorial</em>, <em>fork</em>, <em>clone</em>, or <em>generate</em>.</p>
<h3>Copy from the Tutorial</h3>
<p>To create the application, you can cut and paste the code from the tutorial into your own files. It’s a bit tedious and error-prone but you’ll have a good opportunity to examine the code closely. The tutorial will ask you to use the <a href="http://railsapps.github.com/rails-composer/">Rails Composer</a> tool to generate a starter app to save some steps. Then you can follow the tutorial step-by-step to build the complete application.</p>
<h3>Fork</h3>
<p>If you’d like to add features (or bug fixes) to improve the example application, you can fork the GitHub repo and <a href="http://help.github.com/send-pull-requests/">make pull requests</a>. Your code contributions are welcome!</p>
<h3>Clone</h3>
<p>If you want to copy and customize the app with changes that are only useful for your own project, you can download or clone the GitHub repo. You’ll need to search-and-replace the project name throughout the application. You probably should generate the app instead (see below).</p>
<h3>Generate</h3>
<p>If you wish to skip the tutorial and build the application immediately, use the <a href="http://railsapps.github.com/rails-composer/">Rails Composer</a> tool to generate the complete example app. You’ll be able to give it your own project name when you generate the app. Generating the application gives you additional options.</p>
<p>To build the example application immediately, run the command:</p>
<pre>
$ rails new rails-membership-subscription-saas -m https://raw.github.com/RailsApps/rails-composer/master/composer.rb -T
</pre>
<p>Use the <code>-T</code> flag to skip Test::Unit files.</p>
<p>The <code>$</code> character indicates a shell prompt; don’t include it when you run the command.</p>
<p>This creates a new Rails app named <code>rails-membership-subscription-saas</code> on your computer. You can use a different name if you wish.</p>
<p>You’ll see a prompt:</p>
<pre>
question  Install an example application?
      1)  I want to build my own application
      2)  rails-membership-subscription-saas
      3)  rails-prelaunch-signup
      4)  rails3-bootstrap-devise-cancan
      5)  rails3-devise-rspec-cucumber
      6)  rails3-mongoid-devise
      7)  rails3-mongoid-omniauth
      8)  rails3-subdomains
</pre>
<p>Choose <strong>rails-membership-subscription-saas</strong>. The Rails Composer tool may give you other options (other choices may have been added since this tutorial was written).</p>
<p>The application generator template will ask you for additional preferences:</p>
<pre>
 question  Install a prelaunch app? (y/n)
 question  Web server for development?
       1)  WEBrick (default)
       2)  Thin
       3)  Unicorn
       4)  Puma
 question  Web server for production?
       1)  Same as development
       2)  Thin
       3)  Unicorn
       4)  Puma
 question  Template engine?
       1)  ERB
       2)  Haml
       3)  Slim
   extras  Set a robots.txt file to ban spiders? (y/n)
   extras  Create a project-specific rvm gemset and .rvmrc? (y/n)
   extras  Create a GitHub repository? (y/n)
</pre>
<h4>Prelaunch App</h4>
<p>If you’re planning a prelaunch promotion campaign, or if you need a placeholder page while you build your website, you can a install a prelaunch app. See the <a href="http://railsapps.github.com/rails-prelaunch-signup/">rails-prelaunch-signup</a> example application for details.</p>
<p>If you install a prelaunch app, the generator will ask if you want to create Git branches. This allows you to maintain two versions of the application: one for immediate deployment as a prelaunch app; and another version that you can use for ongoing development. I recommend deploying the prelaunch app in the “master” branch. Work on your ultimate application in a work-in-progress or “wip” branch.</p>
<h4>Web Servers</h4>
<p>Use the default WEBrick server for convenience. If you plan to deploy to Heroku, select “thin” as your production webserver.</p>
<h4>Template Engine</h4>
<p>In this tutorial, we’ll use the default “<span class="caps">ERB</span>” Rails template engine. Optionally, you can use another template engine, such as Haml. See instructions for <a href="http://railsapps.github.com/rails-haml.html">Haml and Rails</a>.</p>
<h4>Other Choices</h4>
<p>Don’t set a robots.txt file to ban spiders if you want your new site to appear in Google search results.</p>
<p>It is a good idea to use <a href="https://rvm.io/">rvm</a>, the Ruby Version Manager, and create a project-specific rvm gemset and .rvmrc file. See <a href="http://railsapps.github.com/installing-rails.html">Installing Rails</a>.</p>
<p>If you choose to create a GitHub repository, the generator will prompt you for a GitHub username and password.</p>
<h4>Troubleshooting</h4>
<p>If you get an error “OpenSSL certificate verify failed” or “Gem::RemoteFetcher::FetchError: SSL_connect” see the article <a href="http://railsapps.github.com/openssl-certificate-verify-failed.html">OpenSSL errors and Rails</a>.</p>
<p>If you get an error like this:</p>
<pre>
Your bundle is complete! Use `bundle show [gemname]` to see where a bundled gem is installed.
    composer  Running 'after bundler' callbacks.
The template [...] could not be loaded.
Error: You have already activated ..., but your Gemfile requires .... 
Using bundle exec may solve this.
</pre>
<p>It’s due to conflicting gem versions. See the article <a href="http://railsapps.github.com/rails-error-you-have-already-activated.html">Rails Error: “You have already activated (…)”</a>.</p>
<h2>Testing and the Software Development Process</h2>
<p>Testing is at the center of any robust software development process. Integration tests determine whether the application’s features work as expected, testing the application from the point of view of the user. Unit tests confirm that the smallest testable portions of the application continue working as developers add features and refactor code.</p>
<p>This example application uses Cucumber for integration testing and RSpec for unit testing. The test suites are part of the code in the GitHub repository and are installed when the application is cloned or generated. This tutorial assumes you’ve learned to write tests elsewhere (see a list of <a href="http://railsapps.github.com/rails.html">recommended resources for Rails</a>). I won’t spend time showing you how to write tests but you can use tests to make sure the application works as expected.</p>
<h2>Architecture and Implementation</h2>
<p>Here is a high-level abstraction of the application, as a list of systems:</p>
<ul>
<li>user management with Devise (to register or remove users)</li>
	<li>authentication with Devise (log in and log out)</li>
	<li>authorization management with CanCan and Rolify (access determined by the subscription plan)</li>
	<li>account management to maintain records of subscription status</li>
	<li>recurring billing with Stripe</li>
	<li>landing pages</li>
	<li>content or service pages</li>
</ul><h3>User Management, Authentication, Authorization</h3>
<p>The tutorial for the <a href="https://github.com/RailsApps/rails3-bootstrap-devise-cancan">rails3-bootstrap-devise-cancan</a> example application shows how to set up user management and authentication using Devise, as well as authorization management using CanCan and Rolify. The first step in the tutorial will be to generate the rails3-bootstrap-devise-cancan application as a starter app.</p>
<p>Users are managed with the User model, which has attributes for name, email, and password, as well as some fields provided by Devise such as sign_in_count. The Devise gem provides its own controllers for managing sessions, registration, email confirmation and similar functions. You won’t see these controllers as they are hidden in the gem itself.</p>
<p>CanCan uses an Ability model to set access control rules. We’ll modify the Ability model to set access rules based on subscription plans. We’ll use the Role model required by Rolify to define roles based on subscription plans.</p>
<h3>Account Management</h3>
<p>The account management system keeps subscription records so the access control system can determine which users are current subscribers. We’ll create a Subscription model. Each user can have a Subscription (a one-to-one association with a User). The Subscription model has a status attribute which can be active, past_due, cancelled or unpaid.</p>
<p>A Subscription controller handles actions such as:</p>
<ul>
<li>change subscription plans (upgrade or downgrade)</li>
</ul><h3>Recurring Billing</h3>
<p>The recurring billing system stores the users’ credit card data and initiates payment transactions.</p>
<p>Two approaches are possible in building a recurring billing system. You could implement a complete billing management system as part of the application. This would require building a mechanism to check for expiring subscriptions (typically a daily cron job) and initiate payment requests through Stripe when a user’s account comes due. With this approach, you would use Stripe only for processing credit card transactions. But there’s no reason to implement recurring billing yourself. Stripe provides a complete, well-tested, and hosted mechanism for recurring billing. We’ll use Stripe’s <span class="caps">API</span> to supply the recurring billing services we need.</p>
<p>A key requirement for the application is to keep the recurring billing and account management systems in sync. We face a problem if we establish a new subscription, hand off recurring billing to Stripe, and then months later find that the subscriber’s credit card has expired and can no longer be billed. We need a mechanism to update our subscription status when Stripe encounters a declined transaction. Stripe provides “webhooks” to set the status of a subscription. When Stripe encounters a declined transaction it will initiate an <span class="caps">HTTP</span> request to our application which we can decode to change a subscription status.</p>
<p>If we didn’t use the Stripe webhooks, we’d have to either query the Stripe <span class="caps">API</span> on each login or run a repeating cron job to check for subscription expiration. The application will be notified immediately by Stripe so there is no need for the overhead of checking on each login. The Stripe webhook mechanism is very robust: If for some reason it cannot make an <span class="caps">HTTP</span> request to our application, it will retry several times with exponential backoff.</p>
<p>A key requirement for any ecommerce site that takes credit cards is <a href="http://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard"><span class="caps">PCI</span> compliance</a> to minimize risk of customer credit card exposure. Using Stripe, your server will never receive sensitive credit card details. Instead you’ll use a the Stripe Javascript library on your subscription payment form which sends the credit card details directly to the Stripe servers. Your site will meet <span class="caps">PCI</span> compliance requirememts if you solely accept payment information through the Stripe Javascript library and serve your payment page over <span class="caps">SSL</span>.</p>
<h3>Landing Pages</h3>
<p>Ideally, landing pages should be static pages that load quickly and can be cached for fast response.</p>
<p>Landing pages serve to describe the value of the content or service and convince the visitor to purchase a subscription. The home page of the application is a landing page. We’ll show you how to add alternative landing pages that can be customized to match specific search terms for better <span class="caps">SEO</span> and an improved conversion rate.</p>
<h3>Content or Service</h3>
<p>We’ll show how to create “semi-static” pages for content.</p>
<p>For this application, we’ll create some placeholder content. For your application, the content can be anything you like: photo galleries, videos, downloadable ebooks. For a SaaS site, subscribers wuld gain access to a web application.</p>
<h2>Create the Rails Application</h2>
<p>Before you write any code, you’ll start by generating a starter app using an application template script.</p>
<p>If you’ve developed other applications in Rails, you’ll know that the <code>rails new</code> command creates a basic Rails application. Here we’ll use the <a href="http://railsapps.github.com/rails-composer/">Rails Composer</a> tool (“like the <code>rails new</code> command on steroids”) to create a starter app. The starter app saves us some steps. Devise will be installed with Cancan for authorization. Twitter Bootstrap will be set up as a front end for <span class="caps">CSS</span> styling. If you want a tutorial that shows you the steps to build the starter app, see the <a href="http://railsapps.github.com/tutorial-rails-bootstrap-devise-cancan.html">rails3-bootstrap-devise-cancan</a> tutorial.</p>
<p>Juat to be clear, if you chose to skip the tutorial and used the Rails Composer tool to generate the complete application, you may already have the complete application on your computer. To build the application step by step, we suggest you delete the application (or move it elsewhere), and follow the tutorial to build the application, starting with the rails3-bootstrap-devise-cancan starter app.</p>
<p>For the starter app we want, use the command:</p>
<pre>
$ rails new rails-membership-subscription-saas -m https://raw.github.com/RailsApps/rails-composer/master/composer.rb -T
</pre>
<p>Use the <code>-T</code> flag to skip Test::Unit files since we’ll be using RSpec.</p>
<p>The <code>$</code> character indicates a shell prompt; don’t include it when you run the command.</p>
<p>This creates a new Rails app named <code>rails-membership-subscription-saas</code> on your computer. You can use a different name if you wish.</p>
<p>You’ll see a prompt:</p>
<pre>
question  Install an example application?
      1)  I want to build my own application
      2)  rails-membership-subscription-saas
      3)  rails-prelaunch-signup
      4)  rails3-bootstrap-devise-cancan
      5)  rails3-devise-rspec-cucumber
      6)  rails3-mongoid-devise
      7)  rails3-mongoid-omniauth
      8)  rails3-subdomains
</pre>
<p>Choose <strong>rails3-bootstrap-devise-cancan</strong>. The Rails Composer tool may give you other options (other choices may have been added since this tutorial was written). Don’t choose “rails-membership-subscription-saas” (unless you want to skip the tutorial).</p>
<p>The application generator template will ask you for additional preferences:</p>
<pre>
 question  Web server for development?
       1)  WEBrick (default)
       2)  Thin
       3)  Unicorn
       4)  Puma
 question  Web server for production?
       1)  Same as development
       2)  Thin
       3)  Unicorn
       4)  Puma
 question  Template engine?
       1)  ERB
       2)  Haml
       3)  Slim
   extras  Set a robots.txt file to ban spiders? (y/n)
   extras  Create a project-specific rvm gemset and .rvmrc? (y/n)
   extras  Create a GitHub repository? (y/n)
</pre>
<p>For this tutorial, choose “WEBrick” for your development and production webserver.</p>
<p>In this tutorial, we’ll use the default “<span class="caps">ERB</span>” Rails template engine. Optionally, you can use another template engine, such as Haml. See instructions for <a href="http://railsapps.github.com/rails-haml.html">Haml and Rails</a>.</p>
<p>You can choose to set a robots.txt file to ban spiders. Choosing “no” makes sense if you want your prelaunch site to show up in Google search results.</p>
<p>If you have installed <a href="https://rvm.io/">rvm</a>, the Ruby Version Manager, I recommend you answer “yes” to the prompt, “Create a project-specific rvm gemset and .rvmrc?” See the article <a href="http://railsapps.github.com/installing-rails.html">Installing Rails</a> to learn about the benefits of using rvm.</p>
<p>Finally, the program will ask if you want to create a GitHub repository. This is optional and not necessary for the tutorial.</p>
<p>After you create the application, switch to its folder to continue work directly in the application:</p>
<p><code>$ cd rails-membership-subscription-saas</code></p>
<h4>Troubleshooting</h4>
<p>If you get an error “OpenSSL certificate verify failed” or “Gem::RemoteFetcher::FetchError: SSL_connect” see the article <a href="http://railsapps.github.com/openssl-certificate-verify-failed.html">OpenSSL errors and Rails</a>.</p>
<p>If you get an error like this:</p>
<pre>
Your bundle is complete! Use `bundle show [gemname]` to see where a bundled gem is installed.
    composer  Running 'after bundler' callbacks.
The template [...] could not be loaded.
Error: You have already activated ..., but your Gemfile requires .... 
Using bundle exec may solve this.
</pre>
<p>It’s due to conflicting gem versions. See the article <a href="http://railsapps.github.com/rails-error-you-have-already-activated.html">Rails Error: “You have already activated (…)”</a>.</p>
<h4>Replace the READMEs</h4>
<p>Please edit the <span class="caps">README</span> files to add a description of the app and your contact info. Changing the <span class="caps">README</span> is important if your app will be publicly visible on GitHub. Otherwise, people will think I am the author of your app. If you like, add an acknowledgment and a link to the <a href="http://railsapps.github.com/">RailsApps project</a>.</p>
<h2>Set Up Source Control (Git)</h2>
<p>When you generate the starter app, the template sets up a source control repository and makes an initial commit of the code.</p>
<p>At your request, the template will also create a GitHub repository for your project.</p>
<p>See detailed instructions for <a href="http://railsapps.github.com/rails-git.html">Git and Rails</a>.</p>
<p>Git has already been initialized by the application template script. If you’ve selected the GitHub option, the template commits your code to your GitHub repository.</p>
<h2>Set Up Gems</h2>
<p>The Rails Composer program sets up your Gemfile and (if you are using rvm) creates a project-specific gemset.</p>
<p>Open your <strong>Gemfile</strong> and you should see the following. Gem version numbers may differ:</p>
<pre>
source 'https://rubygems.org'
gem 'rails', '3.2.8'
gem 'sqlite3'
group :assets do
  gem 'sass-rails',   '~&gt; 3.2.3'
  gem 'coffee-rails', '~&gt; 3.2.1'
  gem 'uglifier', '&gt;= 1.0.3'
end
gem 'jquery-rails'
gem "rspec-rails", "&gt;= 2.11.0", :group =&gt; [:development, :test]
gem "capybara", "&gt;= 1.1.2", :group =&gt; :test
gem "email_spec", "&gt;= 1.2.1", :group =&gt; :test
gem "cucumber-rails", "&gt;= 1.3.0", :group =&gt; :test, :require =&gt; false
gem "database_cleaner", "&gt;= 0.8.0", :group =&gt; :test
gem "launchy", "&gt;= 2.1.2", :group =&gt; :test
gem "factory_girl_rails", "&gt;= 4.0.0", :group =&gt; [:development, :test]
gem "bootstrap-sass", "&gt;= 2.1.0.0"
gem "devise", "&gt;= 2.1.2"
gem "cancan", "&gt;= 1.6.8"
gem "rolify", "&gt;= 3.2.0"
</pre>
<p>Add the following gems which will be needed for the rails-membership-subscription-saas application:</p>
<pre>
gem "simple_form"
</pre>
<p>Check for the <a href="http://rubygems.org/gems/rails">current version of Rails</a> and replace <code>gem 'rails', '3.2.8'</code> accordingly.</p>
<p><em>Note:</em> Rails Composer templates are created by the <a href="https://github.com/RailsApps/rails_apps_composer">Rails Apps Composer Gem</a>. For that reason, groups such as <code>:development</code> or <code>:test</code> are specified inline. You can reformat the Gemfiles to organize groups in an eye-pleasing block style. The functionality is the same.</p>
<h3>Install the Required Gems</h3>
<p>When you add a new gem to the Gemfile, you should run the <code>bundle install</code> command to install the required gems on your computer. Run:</p>
<pre>
bundle install
</pre>
<p>You can check which gems are installed on your computer with:</p>
<pre>
$ gem list
</pre>
<p>Keep in mind that you have installed these gems locally. When you deploy the app to another server, the same gems (and versions) must be available.</p>
<h2>RSpec</h2>
<p>The starter app script sets up RSpec for unit testing. Run <code>rake -T</code> to check that rake tasks for RSpec are available. You should be able to run <code>rake spec</code> to run all specs provided with the example app. To learn more about using RSpec, refer to <a href="http://www.pragprog.com/titles/achbd/the-rspec-book">The RSpec Book</a>.</p>
<h2>Cucumber</h2>
<p>The starter app script sets up Cucumber for specifications and acceptance testing. To learn more about using Cucumber, refer to <a href="http://pragprog.com/book/hwcuc/the-cucumber-book">The Cucumber Book</a> or the free introduction to Cucumber, <a href="http://cuke4ninja.com/">The Secret Ninja Cucumber Scrolls</a>.</p>
<p>You should be able to run <code>rake cucumber</code>, or more simply, <code>cucumber</code>, to run the Cucumber scenarios and steps provided with the example app. You can run a single Cucumber feature with a command such as:</p>
<pre>
$ cucumber features/visitors/request_invitation.feature
</pre>
<p>If you’ve used Cucumber, you may know that you need to add <code>--require features</code> to run a single Cucumber feature. Here it is not necessary to do so; the starter app script sets up the <strong>config/cucumber.yml</strong> file so it is not necessary to add <code>--require features</code>.</p>
<h2>Configure Email</h2>
<p>You must configure the app for your email account so your application can send email messages, for example, to acknowledge invitation requests or send welcome messages.</p>
<p>The starter app script sets up a default email configuration. You must add details about your email account.</p>
<h3>Configure ActionMailer</h3>
<p>ActionMailer is configured for development in the <strong>config/environments/development.rb</strong> file:</p>
<pre>
# ActionMailer Config
config.action_mailer.default_url_options = { :host =&gt; 'localhost:3000' }
config.action_mailer.delivery_method = :smtp
# change to true to allow email to be sent during development
config.action_mailer.perform_deliveries = false
config.action_mailer.raise_delivery_errors = true
config.action_mailer.default :charset =&gt; "utf-8"
</pre>
<p>ActionMailer is configured for production in the <strong>config/environments/production.rb</strong> file:</p>
<pre>
config.action_mailer.default_url_options = { :host =&gt; 'example.com' }
# ActionMailer Config
# Setup for production - deliveries, no errors raised
config.action_mailer.delivery_method = :smtp
config.action_mailer.perform_deliveries = true
config.action_mailer.raise_delivery_errors = false
config.action_mailer.default :charset =&gt; "utf-8"
</pre>
<p>ActionMailer is configured for testing in  the <strong>config/environments/test.rb</strong> file:</p>
<pre>
# ActionMailer Config
config.action_mailer.default_url_options = { :host =&gt; 'example.com' }
</pre>
<p>This will set the example application to deliver email in production. Email messages are visible in the log file so there is no need to send email in development. The configuration above will raise delivery errors in development but not in production.</p>
<p>In development, <code>config.action_mailer.default_url_options</code> is set for a host at <code>localhost:3000</code> which will enable links in Devise confirmation email messages to work properly during development.</p>
<p>For testing, <code>config.action_mailer.default_url_options</code> is set for a host at <code>example.com</code>. Any value allows tests to run.</p>
<p>For production, you’ll need to change the <code>config.action_mailer.default_url_options</code> host option from <code>example.com</code> to your own domain.</p>
<h3>Use a Gmail account</h3>
<p>Use Gmail for experimenting, if you want to keep things simple.</p>
<p>You’ll need to modify the files <strong>config/environments/development.rb</strong> and <strong>config/environments/production.rb</strong>:</p>
<pre>
config.action_mailer.smtp_settings = {
  address: "smtp.gmail.com",
  port: 587,
  domain: "example.com",
  authentication: "plain",
  enable_starttls_auto: true,
  user_name: ENV["GMAIL_USERNAME"],
  password: ENV["GMAIL_PASSWORD"]
}
</pre>
<p>You can replace <code>ENV["GMAIL_USERNAME"]</code> and <code>ENV["GMAIL_PASSWORD"]</code> with your Gmail username and password. However, committing the file to a public GitHub repository will expose your secret password.</p>
<h3>Use a Mandrill account</h3>
<p>Use an <span class="caps">SMTP</span> relay service such as Mandrill if you want to increase deliverability for email messages from your app.</p>
<p>You’ll need to modify the files <strong>config/environments/development.rb</strong> and <strong>config/environments/production.rb</strong>:</p>
<pre>
config.action_mailer.smtp_settings = {
  :address   =&gt; "smtp.mandrillapp.com",
  :port      =&gt; 25,
  :user_name =&gt; ENV["MANDRILL_USERNAME"],
  :password  =&gt; ENV["MANDRILL_API_KEY"]
}
</pre>
<p>Note that the password will be your Mandrill <span class="caps">API</span> key.</p>
<p>You can replace <code>ENV["MANDRILL_USERNAME"]</code> and <code>ENV["MANDRILL_API_KEY"]</code> with your Mandrill username and <span class="caps">API</span> key. However, committing the file to a public GitHub repository will expose your secret <span class="caps">API</span> key.</p>
<h3>Keep Email Account Passwords Secret</h3>
<p>If you’re familiar with setting <a href="http://en.wikipedia.org/wiki/Environment_variable">Unix environment variables</a>, it’s advisable to leave <code>config.action_mailer.smtp_settings</code> unchanged and set your environment variables in the file that is read when starting an interactive shell (the <strong>~/.bashrc</strong> file for the bash shell). This will keep the password out of your repository.</p>
<p>Are you using a bash shell? Use <code>echo $SHELL</code> to find out. For a bash shell, edit the <strong>~/.bashrc</strong> file and add (for Gmail):</p>
<pre>
export GMAIL_USERNAME="myname@gmail.com"
export GMAIL_PASSWORD="secret"
</pre>
<p>or for Mandrill:</p>
<pre>
export MANDRILL_USERNAME="myname"
export MANDRILL_API_KEY="secret"
</pre>
<p>If you intend to use MailChimp for managing a mailing list, add your MailChimp <span class="caps">API</span> key:</p>
<pre>
export MAILCHIMP_API_KEY="secret"
</pre>
<p>If you’ve set Unix environment variables, open a new shell or restart your terminal application to continue.</p>
<h3>Configure Devise for Email</h3>
<p>Complete your email configuration by modifying</p>
<p><strong>config/initializers/devise.rb</strong></p>
<p>and setting the <code>config.mailer_sender</code> option for the return email address for messages that Devise sends from the application.</p>
<h2>Set Up the Database</h2>
<h3>Create a Default User</h3>
<p>You’ll want to set up a default user so you can test the app. The file <strong>db/seeds.rb</strong> already contains:</p>
<pre>
puts 'SETTING UP DEFAULT USER LOGIN'
user = User.create! :name =&gt; 'First User', :email =&gt; 'user@example.com', :password =&gt; 'please', :password_confirmation =&gt; 'please'
puts 'New user created: ' &lt;&lt; user.name
user2 = User.create! :name =&gt; 'Second User', :email =&gt; 'user2@example.com', :password =&gt; 'please', :password_confirmation =&gt; 'please'
puts 'New user created: ' &lt;&lt; user2.name
user.add_role :admin
</pre>
<p>You can change the values for name, email, and password as you wish.</p>
<p>If you include your private password in the file, be sure to add the filename to your <strong>.gitignore</strong> file so that your password doesn’t become available in your public GitHub repository.</p>
<p>Note that it’s not necessary to personalize the <strong>db/seeds.rb</strong> file before you deploy your app. You can deploy the app with an example user and then use the application’s “Edit Account” feature to change name, email address, and password after you log in.</p>
<h3>Seed the Database</h3>
<p>The starter app script has already set up the database and added the default user by running:</p>
<pre>
$ rake db:migrate
$ rake db:seed
</pre>
<p>If you change the default user’s name, email, or password you’ll need to reset the database:</p>
<pre>
$ rake db:reset
</pre>
<p>You can run <code>$ rake db:reset</code> whenever you need to recreate the database.</p>
<p>You’ll also need to set up the database for testing:</p>
<pre>
$ rake db:test:prepare
</pre>
<p>If you’re not using rvm, the <a href="https://rvm.io/">Ruby Version Manager</a>, you should preface each rake command with <code>bundle exec</code>. You don’t need to use <code>bundle exec</code> if you are using rvm version 1.11.0 or newer.</p>
<h2>Test the Starter App</h2>
<p>At this point, the app is identical to the <a href="https://github.com/RailsApps/rails3-bootstrap-devise-cancan">rails3-bootstrap-devise-cancan</a> starter app.</p>
<p>You can check that the example app runs properly by entering the command</p>
<p><code>$ rails server</code></p>
<p>To see your application in action, open a browser window and navigate to <a href="http://localhost:3000">http://localhost:3000/</a>. You should see the default user listed on the home page. When you click on the user’s name, you should be required to log in before seeing the user’s detail page.</p>
<p>Stop the server with Control-C.</p>
<p>If you test the app by starting the web server and then leave the server running while you install new gems, you’ll have to restart the server to see any changes. The same is true for changes to configuration files in the <strong>config</strong> folder. This can be confusing to new Rails developers because you can change files in the <strong>app</strong> folders without restarting the server. Stop the server each time after testing and you will avoid this issue.</p>
<h2>Replace the Home Page</h2>
<p>If you’ve tested the example app, you’ve seen that any user who logs in will see a list of all the users on the home page. That’s fine for an example app but it’s not what we want for a subscription site.</p>
<h3>A New Home Page</h3>
<p>We’ll put our subscription offer and pricing plan on the home page. You might want to modify the application to describe your offer on the home page with pricing on a separate page. For this tutorial, it’s simplest to show the offer and prices right on the home page.</p>
<p>Replace the contents of the file <strong>app/views/home/index.html.erb</strong>:</p>
<pre>
&lt;div id="welcome" class="hero-unit span7"&gt;
  &lt;h1&gt;Membership Site&lt;/h1&gt;
  &lt;h3&gt;Learn to build a successful subscription site.&lt;/h3&gt;
&lt;/div&gt;
&lt;div class="row span8 plans"&gt;
  &lt;div class="span2 well"&gt;
    &lt;div class="plan"&gt;&lt;h2&gt;Silver&lt;/h2&gt;&lt;/div&gt;
    &lt;ul class="unstyled"&gt;
      &lt;li&gt;One secret a month&lt;/li&gt;
    &lt;/ul&gt;
    &lt;h3&gt;$9/month&lt;/h3&gt;
    &lt;%= button_to 'Subscribe', content_silver_path, :method =&gt; :get, :class =&gt; 'btn btn-primary' %&gt; 
  &lt;/div&gt;
  &lt;div class="span2 well featured"&gt;
    &lt;div class="plan featured-plan"&gt;&lt;h2&gt;Gold&lt;/h2&gt;&lt;/div&gt;
    &lt;ul class="unstyled"&gt;
      &lt;li&gt;Ten secrets a month&lt;/li&gt;
    &lt;/ul&gt;
    &lt;h3&gt;$19/month&lt;/h3&gt;
    &lt;%= button_to 'Subscribe', content_gold_path, :method =&gt; :get, :class =&gt; 'btn btn-primary' %&gt; 
  &lt;/div&gt;
  &lt;div class="span2 well"&gt;
    &lt;div class="plan"&gt;&lt;h2&gt;Platinum&lt;/h2&gt;&lt;/div&gt;
    &lt;ul class="unstyled"&gt;
      &lt;li&gt;Thirty secrets a month&lt;/li&gt;
    &lt;/ul&gt;
    &lt;h3&gt;$29/month&lt;/h3&gt;
    &lt;%= button_to 'Subscribe', content_platinum_path, :method =&gt; :get, :class =&gt; 'btn btn-primary' %&gt; 
  &lt;/div&gt;
&lt;/div&gt;
</pre>
<h3>
<span class="caps">CSS</span> for Subscription Plans</h3>
<p>First, modify the <strong>app/assets/stylesheets/application.css.scss</strong> file to remove the following <span class="caps">CSS</span> rules. These rules were useful for the starter app but will not be used in our application:</p>
<pre>
.content {
  background-color: #eee;
  padding: 20px;
  margin: 0 -20px; /* negative indent the amount of the padding to maintain the grid system */
  -webkit-border-radius: 0 0 6px 6px;
  -moz-border-radius: 0 0 6px 6px;
  border-radius: 0 0 6px 6px;
  -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.15);
  -moz-box-shadow: 0 1px 2px rgba(0,0,0,.15);
  box-shadow: 0 1px 2px rgba(0,0,0,.15);
}
</pre>
<p>Next we’ll add <span class="caps">CSS</span> assets to style the home page.</p>
<p>Create a file <strong>app/assets/stylesheets/pricing.scss</strong>:</p>
<pre>
.plans{
  text-align: center;
}
.featured{
  -webkit-transform:scale(1.15); 
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.67);
}
.plan{
  background-color: #111575;
}
.plan.featured-plan{
  background-color: #CCAB00;
}
.plan h2{
  line-height: 100px;
  color: #fff;
}
</pre>
<p>This stylesheet will be automatically added to the asset pipeline because any files in the same folder as the <strong>app/assets/stylesheets/application.css.scss</strong> file are added by the <code>*= require_tree .</code> statement.</p>
<p>This <span class="caps">CSS</span> will provide the design elements that are commonly seen on a pricing page: boxes for each plan with an enlarged box for a “featured plan.”</p>
<p>The design is adequate for our tutorial but you may want to improve it to be more effective. If you’re not a designer, you may want to look at the Twitter Bootstrap themes available in the <a href="https://wrapbootstrap.com/">WrapBootstrap</a> marketplace. The theme for <a href="https://wrapbootstrap.com/theme/css3-pricing-tables-WB00H9006">CSS3 Pricing Tables</a> is particularly interesting. It only costs $6 and you can easily integrate it into our application by copying the contents of the designer’s <strong>css/custom.css</strong> file into our <strong>app/assets/stylesheets/pricing.scss</strong> file and replacing styles in our <strong>app/views/home/index.html.erb</strong> file.</p>
<h3>Modify the Home Controller</h3>
<p>Modify the file <strong>app/controllers/home_controller.rb</strong> to remove the <code>index</code> method:</p>
<pre>
class HomeController &lt; ApplicationController
end
</pre>
<h3>Commit to Git</h3>
<p>Commit your changes to git:</p>
<pre>
$ git add .
$ git commit -m "home page update"
</pre>
<h2>Add Content Pages</h2>
<p>We’ll add placeholder pages for our valuable content.</p>
<p>First we’ll set up our git workflow for adding a new feature.</p>
<h3>Git Workflow</h3>
<p>When you are using git for version control, you can commit every time you save a file, even for the tiniest typo fixes. If only you will ever see your git commits, no one will care. But if you are working on a team, either commercially or as part of an open source project, you will drive your fellow programmers crazy if they try to follow your work and see such “granular” commits. Instead, get in the habit of creating a git branch each time you begin work to implement a feature. When your new feature is complete, merge the branch and “squash” the commits so your comrades see just one commit for the entire feature.</p>
<p>Create a new git branch for this feature:</p>
<pre>
$ git checkout -b content-pages
</pre>
<p>The command creates a new branch named “content-pages” and switches to it, analogous to copying all your files to a new directory and moving to work in the new directory (though that is not really what happens with git).</p>
<h3>Create the Content Controller and Views</h3>
<p>Use the <code>rails generate</code> command to create a controller and associated views:</p>
<pre>
$ rails generate controller content silver gold platinum --skip-stylesheets --skip-javascripts
</pre>
<p>We’ve named the controller the “ContentController.” We’ve asked for three views, corresponding to the three subscription plans we’ll offer. We’ll ask the generator not to create stylesheet and Javascript files.</p>
<p>The Rails generator will create several files for you:</p>
<pre>
app/controllers/content_controller.rb
app/helpers/content_helper.rb
app/views/content/gold.html.erb
app/views/content/platinum.html.erb
app/views/content/silver.html.erb
spec/controllers/content_controller_spec.rb
</pre>
<p>It also modifies the <strong>config/routes.rb</strong> file to add three routes:</p>
<pre>
get "content/silver"
get "content/gold"
get "content/platinum"
</pre>
<p>The controller is very simple:</p>
<pre>
class ContentController &lt; ApplicationController

  def silver
  end

  def gold
  end
  
  def platinum
  end
end
</pre>
<p>It may be odd to see a controller that doesn’t contain the familar <code>index</code>, <code>show</code>, etc. methods of a RESTful controller. This is a case where a RESTful controller is not needed or appropriate. By default, the controller will render a view corresponding to each action. In fact, we don’t even need to define each method. For clarity, we’ll leave the methods in place to provide clues to the developers.</p>
<h3>Modify the Content Views</h3>
<p>Open each of the view files to see the placeholder content.</p>
<p><strong>app/views/content/silver.html.erb</strong></p>
<pre>
&lt;h1&gt;Content#silver&lt;/h1&gt;
&lt;p&gt;Find me in app/views/content/silver.html.erb&lt;/p&gt;
</pre>
<p><strong>app/views/content/gold.html.erb</strong></p>
<pre>
&lt;h1&gt;Content#gold&lt;/h1&gt;
&lt;p&gt;Find me in app/views/content/gold.html.erb&lt;/p&gt;
</pre>
<p><strong>app/views/content/platinum.html.erb</strong></p>
<pre>
&lt;h1&gt;Content#platinum&lt;/h1&gt;
&lt;p&gt;Find me in app/views/content/platinum.html.erb&lt;/p&gt;
</pre>
<p>If you’re building a real application, you’ll want to provide content that has greater value than our placeholders. For a membership site that delivers content such as ebooks or videos, you could use a structure such as this, where we’ll restrict access to pages in a <strong>content</strong> directory based on the user’s subscription plan. For a site that delivers sotware as a service, the structure of your application will necessarily be more complex.</p>
<h3>Test the Content Pages</h3>
<p>You can check that the example app runs properly by entering the command</p>
<p><code>$ rails server</code></p>
<p>Visit <a href="http://localhost:3000">http://localhost:3000/</a> to see your subscription offer.</p>
<p>Visit <a href="http://localhost:3000/content/silver">http://localhost:3000/content/silver.html</a> to see one of the content pages.</p>
<p>Next we’ll set up access control to limit access to the content pages.</p>
<h3>Git Workflow</h3>
<p>If you haven’t commited any changes yet, commit your changes to git:</p>
<pre>
$ git add .
$ git commit -am "add content pages"
</pre>
<p>Since the new feature is complete, merge the working branch to “master” and squash the commits so you have just one commit for the entire feature:</p>
<pre>
$ git checkout master
$ git merge --squash content-pages
$ git commit -am "add content pages"
</pre>
<p>You can delete the working branch when you’re done:</p>
<pre>
$ git branch -D content-pages
</pre>
<h2>More to Come</h2>
<p>Work in progress.</p>
<h2>Test the App</h2>
<p>You can check that your app runs properly by entering the command:</p>
<p><code>$ rails server</code></p>
<p>To see your application in action, open a browser window and navigate to <a href="http://localhost:3000">http://localhost:3000/</a>.</p>
<p>Sign in as the first user (the administrator) using:</p>
<ul>
<li>email: user@example.com</li>
	<li>password: please</li>
</ul><p>You’ll see a navigation link for Admin. Clicking the link will display a page with a list of users at<br><a href="http://localhost:3000/users">http://localhost:3000/users</a>.</p>
<p>To sign in as the second user, use</p>
<ul>
<li>email: user2@example.com</li>
	<li>password: please</li>
</ul><p>The second user will not see the Admin navigation link and will not be able to access the page at<br><a href="http://localhost:3000/users">http://localhost:3000/users</a>.</p>
<p>If you want to see what the admininstrative dashboard looks like with many users, you can add a line to the <strong>db/seeds.rb</strong> file to create a hundred bogus users:</p>
<pre>
100.times {|i| User.create! :name =&gt; "User #{i+3}", :email =&gt; "user#{i+3}@example.com", :password =&gt; 'please', :password_confirmation =&gt; 'please', :confirmed_at =&gt; (Time.now + i.day).utc, :created_at =&gt; (Time.now + i.day).utc  }
</pre>
<p>You’ll have to modify the file <strong>app/models/user.rb</strong> to allow mass assignment of the <code>created_at</code> field:</p>
<pre>
attr_accessible :name, :email, :password, :password_confirmation, :remember_me, :opt_in, :created_at
</pre>
<p>Then run <code>$ rake db:reset</code> to recreate the database and visit the site again.</p>
<h2>Deploy to Heroku</h2>
<p>Heroku provides low cost, easily configured Rails application hosting. For your convenience, see <a href="http://railsapps.github.com/rails-heroku-tutorial.html">Tutorial: Rails on Heroku</a>.</p>
<h2>Conclusion</h2>
<p>This concludes the tutorial for the RailsApp <a href="https://github.com/RailsApps/rails-membership-subscription-saas">rails-membership-subscription-saas</a> example app.</p>
<h3>Did You Like the Tutorial? Here’s What You Can Do</h3>
<p>Was this useful to you? Follow <a href="http://twitter.com/rails_apps">rails_apps</a> on Twitter and tweet some praise. I’d love to know you were helped out by the tutorial.</p>
<p>Get some link juice! Add your website to the list of <a href="http://railsapps.github.com/rails-applications-from-examples.html">Rails Applications Built from the Examples</a>. I love to see what people have built with these examples.</p>
<p>Any issues? Please create an <a href="http://github.com/RailsApps/rails-membership-subscription-saas/issues">issue</a> on GitHub. Reporting (and patching!) issues helps everyone.</p>
<h3>Credits</h3>
<p>Daniel Kehoe implemented the application and wrote the tutorial.</p>
    </div><!-- class="content" -->
    
    <div class="comments">
      <div class="content wikistyle gollum">
        <h2>Comments</h2>
      </div>
      <p>Is this helpful? Your encouragement fuels the project. Please tweet or add a comment. Couldn't get something to work? For the example apps and tutorials, it's best to open an issue on GitHub so we can help you.</p> 
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'railsapps'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div><!-- class="comments" -->

    <div class="footer row">
      <div class="span4">
      </div>
    
      <div class="span4">
       </div>

      <div class="span4">
      </div>
    </div>

  </div>
            
  </body>
</html>
