<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Rails Tutorial for a Startup Prelaunch Signup Site</title>
    <link href="https://plus.google.com/u/0/b/117374718581973393536/117374718581973393536/posts/" rel="publisher" />
    <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="/css/screen.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="/css/gollum.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="/css/site.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" charset="utf-8" />
    <script src="http://code.jquery.com/jquery-1.6.min.js" type="text/javascript"></script>
    <script src="/javascript/jquery.text_selection-1.0.0.min.js" type="text/javascript"></script>
    <script src="/javascript/jquery.previewable_comment_form.js" type="text/javascript"></script>
    <script src="/javascript/jquery.tabs.js" type="text/javascript"></script>
    <script src="/javascript/gollum.js" type="text/javascript"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-5109366-14']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>

  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a href="/" class="brand">RailsApps Project</a>
        <ul class="pull-right nav">
          <li><a href="http://blog.railsapps.org/" class="twitter">Blog</a></li>
          <li><a href="http://twitter.com/rails_apps" class="twitter">Twitter</a></li>
          <li><a href="https://plus.google.com/117374718581973393536" class="google">Google +</a></li>
          <li><a href="https://github.com/RailsApps" class="github">GitHub Repository</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container"> 
    
    <div class="page-header">
      <h1>Rails Tutorial for a Startup Prelaunch Signup Site</h1>
    </div>

    <div class="content wikistyle gollum textile">
      <h1>Rails Tutorial for a Startup Prelaunch Signup Site</h1>
<h4>by Daniel Kehoe</h4>
<p>
  <em>Last updated 9 April 2012</em>
</p>
<p>Ruby on Rails tutorial showing how to create a “beta launching soon” application for a startup prelaunch site with a signup page.</p>
<p>
  <strong>This tutorial is in development. It is not finished. Click GitHub “Watch” to follow progress. Or follow  <a href="http://twitter.com/rails_apps">@rails_apps</a> on Twitter for project announcements.</strong>
</p>
<p>You can create the example app from this tutorial or clone the <a href="http://github.com/RailsApps/rails-prelaunch-signup/">rails-prelaunch-signup</a> repository for the complete application.</p>
<h2><a href="http://www.twitter.com/rails_apps"><img src="http://twitter-badges.s3.amazonaws.com/t_logo-a.png" title="Follow on Twitter" alt="Follow on Twitter" /></a> Follow on Twitter</h2>
<p>Follow the project on Twitter: <a href="http://twitter.com/rails_apps">@rails_apps</a>. Tweet some praise if you like what you’ve found.</p>
<h2>Introduction</h2>
<p>Typically, the initial app for many web startups announces the founders’ plans and encourages visitors to enter an email address for future notification of the site’s launch. It’s not difficult to build such an app in Rails. But why build it yourself if others have already done so? That’s the aim of this project:</p>
<ul><li>eliminate effort spent building an application that meets a common need;</li>
	<li>offer code that is already implemented and tested by a large community;</li>
	<li>provide a well-thought-out app containing most of the features you’ll need.</li>
</ul><p>By deploying this application, you’ll be able to:</p>
<ul><li>direct more attention to the design and product offer for your prelaunch site;</li>
	<li>get started faster building the ultimate application for your business.</li>
</ul><p>The example app and tutorial also help founders who are new to Ruby on Rails to learn how to build a real-world Rails web application.</p>
<h3>Why We Use Devise</h3>
<p>We’ve chosen to use the <a href="http://github.com/plataformatec/devise">Devise</a> gem for our authentication and user management. We use Devise because it offers a full set of features used in more complex applications, such as recovering a user’s forgotten password or allowing users to invite friends. By using Devise for the prelaunch signup application, you can use the same user database for your post-launch product. You’ll also have the benefit of receiving help from a large community of developers using Devise, should you need help in troubleshooting or customizing the implementation.</p>
<h3>How We Configure Devise</h3>
<p>Devise offers many configuration options; in fact, exploring its configuration choices can take more time than actually implementing <a href="http://railscasts.com/episodes/250-authentication-from-scratch">authentication from scratch</a>. We’ve reviewed Devise’s features and selected the configuration that best accommodates a typical web startup signup site.</p>
<p>Devise handles signing up users through a registration feature. We use the Devise registration process to collect email addresses and create user accounts. Instead of confirming an email address immediately, we email a “thank you for your request” acknowledgment and postpone the email confirmation step. When you are ready to invite users to the site, the app provides an administrative interface so you can select users to receive an invitation that instructs them to confirm their email address and set a password.</p>
<p>If you need slightly different functionality, <a href="https://github.com/plataformatec/devise/wiki">the Devise wiki</a> and <a href="http://stackoverflow.com/questions/tagged/devise">answers on Stack Overflow</a> can help you alter this implementation.</p>
<h3>RailsApps Examples and Tutorials</h3>
<p>This app is based on the <a href="https://github.com/RailsApps/rails3-devise-rspec-cucumber">rails3-devise-rspec-cucumber</a> starter app. Using the rails3-devise-rspec-cucumber example gives you a known working application with the basic features most developers need when they build a Rails app. This tutorial shows how to generate the starter app and then modify it to add prelaunch signup features.</p>
<p>As an alternative, you can use the <a href="https://github.com/RailsApps/rails3-mongoid-devise">rails3-mongoid-devise</a> starter app if you want to use the MongoDB datastore instead of ActiveRecord and a <span class="caps">SQL</span> database.</p>
<p>This is one in a series of Rails example apps and tutorials from the <a href="http://railsapps.github.com/">RailsApps Project</a>. See a list of similar <a href="http://railsapps.github.com/rails-examples-tutorials.html">Rails examples, tutorials, and starter apps</a>.</p>
<h2><img src="http://railsapps.github.com/images/rails-36x36.jpg" title="Tutorial" alt="Tutorial" /> Tutorial</h2>
<p>This tutorial documents each step that you must follow to create this application. Every step is documented concisely, so a complete beginner can create this application without any additional knowledge. However, no explanation is offered for any of the steps, so if you are a beginner, you’re advised to look for an introduction to Rails elsewhere. See resources for getting started with <a href="http://railsapps.github.com/rails.html">Rails</a>.</p>
<h2>Before You Start</h2>
<p>If you follow this tutorial closely, you’ll have a working application that closely matches the example app in this GitHub repository. The example app is your reference implementation. If you find problems with the app you build from this tutorial, download the example app (in Git speak, clone it) and use a file compare tool to identify differences that may be causing errors. On a Mac, <a href="http://stackoverflow.com/questions/187064/graphical-diff-for-mac-os-x">good file compare tools</a> are <a href="http://en.wikipedia.org/wiki/Apple_Developer_Tools#FileMerge">FileMerge</a>, <a href="http://sourcegear.com/diffmerge/">DiffMerge</a>, <a href="http://www.kaleidoscopeapp.com/">Kaleidoscope</a>, or Ian Baird’s <a href="http://www.changesapp.com/">Changes</a>.</p>
<p>If you clone and install the example app and find problems or wish to suggest improvements, please create a <a href="http://github.com/RailsApps/rails-prelaunch-signup/issues">GitHub issue</a>.</p>
<p>To improve this tutorial, please edit this wiki page or leave comments below.</p>
<h2>Creating the Application</h2>
<h3>Option One</h3>
<p>
  <em>Follow this tutorial.</em>
</p>
<p>To create the application, you can cut and paste the code from the tutorial into your own files. It’s a bit tedious and error-prone but you’ll have a good opportunity to examine the code closely.</p>
<h3>Option Two</h3>
<p>
  <em>Use the ready-made application template to generate the code.</em>
</p>
<p>We’ll soon offer an application template to generate a new Rails app with code that closely matches the tutorial. It’s not available yet.</p>
<h2>Assumptions</h2>
<p>Before beginning this tutorial, you need to install</p>
<ul><li>The Ruby language (version 1.9.3)</li>
	<li>Rails 3.2</li>
</ul><p>Check that appropriate versions of Ruby and Rails are installed in your development environment:<br /><code>$ ruby -v</code><br /><code>$ rails -v</code></p>
<p>Be sure to read <a href="http://railsapps.github.com/installing-rails.html">Installing Rails</a> for detailed instructions and advice.</p>
<h2>About the Software Development Process</h2>
<p>Arguably, for a simple application like this, you don’t need a lot of ceremony. There’s no need for a written specification. And no need for tests, right? Just code it up. However, for the purposes of this tutorial, I want to show the practices that establish a good software development process. You may find it beneficial to use the same process when you develop more complex applications.</p>
<p>Here’s the software development process we’ll use:</p>
<ul><li>write user stories</li>
	<li>write a short specification for our feature set using Cucumber scenarios</li>
	<li>create acceptance tests using Cucumber step definitions</li>
	<li>code each feature</li>
	<li>run acceptance tests as each feature is completed</li>
</ul><p>By practicing the process that leads from concept to code, you’ll be prepared to build more complex applications.</p>
<h3>Write Your User Stories</h3>
<p><a href="http://en.wikipedia.org/wiki/User_story">User stories</a> are a way to discuss and describe the requirements for a software application. The process of writing user stories will help you identify all the features that are needed for your application. Breaking down the application’s functionality into discrete user stories will help you organize your work and track progress toward completion.</p>
<p>User stories are generally expressed in the following format:</p>
<pre>
As a &lt;role&gt;, I want &lt;goal&gt; so that &lt;benefit&gt;
</pre>
<p>As an example, here are three user stories we will implement for this application:</p>
<pre>
*Request Invitation*
As a visitor to the website
I want to request an invitation 
so I'll be notified when the site is launched

*View Progress*
As the owner of the site
I want to know how many visitors have requested invitations
so I can know if my offer is popular

*Collect Email Addresses*
As the owner of the site
I want to collect email addresses for a mailing list
so I can send an announcement when I launch the site
</pre>
<p>Here’s a list of <a href="https://github.com/RailsApps/rails-prelaunch-signup/blob/master/stories/implemented.textile">user stories that have been implemented</a>. There is also a list of <a href="https://github.com/RailsApps/rails-prelaunch-signup/blob/master/stories/unimplemented.textile">user stories that have not been implemented</a>. If you have ideas for additional features for this application, edit the file and submit a pull request. Or simply create a <a href="http://github.com/RailsApps/rails-prelaunch-signup/issues">GitHub issue</a>.</p>
<h2>Create the Rails Application</h2>
<p>Before you write any code, you’ll start by generating an example app using an application template script.</p>
<p>If you want to know more about the starter app, read the <a href="http://railsapps.github.com/tutorial-rails-devise-rspec-cucumber.html">tutorial for the rails3-devise-rspec-cucumber</a> app.</p>
<p>The <code>$</code> character indicates a shell prompt; don’t include it when you run the command.</p>
<p>For a starter app using ActiveRecord and a <span class="caps">SQL</span> database, use the command:</p>
<pre>
$ rails new rails-prelaunch-signup -m https://raw.github.com/RailsApps/rails3-application-templates/master/rails3-devise-rspec-cucumber-template.rb -T
</pre>
<p>Use the <code>-T</code> flags to skip Test::Unit files.</p>
<p>If you want to use the MongoDB datastore instead of ActiveRecord and a <span class="caps">SQL</span> database use the <a href="https://github.com/RailsApps/rails3-mongoid-devise">rails3-mongoid-devise</a> starter app:</p>
<pre>
$ rails new rails-prelaunch-signup -m https://github.com/RailsApps/rails3-application-templates/raw/master/rails3-mongoid-devise-template.rb -T -O
</pre>
<p>Use the <code>-T -O</code> flags to skip Test::Unit files and Active Record files.</p>
<p>This creates a new Rails app named <code>rails-prelaunch-signup</code> on your computer. You can use a different name if you wish.</p>
<p>The application generator template will ask you for your preferences. For this tutorial, choose the following preferences:</p>
<ul><li>Would you like to use <a href="http://en.wikipedia.org/wiki/Haml">Haml</a> instead of <span class="caps">ERB</span>? <strong>Yes.</strong></li>
	<li>Would you like to use <a href="http://rspec.info/">RSpec</a> instead of TestUnit? <strong>Yes.</strong></li>
	<li>Would you like to use <a href="https://github.com/thoughtbot/factory_girl">factory_girl</a> for test fixtures with RSpec? <strong>Yes.</strong></li>
	<li>Would you like to use <a href="https://github.com/notahat/machinist">machinist</a> for test fixtures with RSpec? <strong>No.</strong></li>
	<li>Would you like to use <a href="http://cukes.info/">Cucumber</a> for your <span class="caps">BDD</span>? <strong>Yes.</strong></li>
	<li>Would you like to use <a href="http://intridea.com/posts/hire-a-guard-for-your-project">Guard</a> to automate your workflow? <strong>No.</strong></li>
	<li>Would you like the app to use a Gmail account to send email? <strong>Yes.</strong></li>
	<li>Would you like to use Devise for authentication? <strong>Devise with Confirmable and Invitable modules</strong></li>
	<li>Which front-end framework would you like for HTML5 and CSS3? <strong>Twitter Bootstrap (sass)</strong></li>
	<li>Which form gem would you like? <strong>simple form (bootstrap)</strong></li>
	<li>Would you like to use <a href="https://github.com/josevalim/rails-footnotes">rails-footnotes</a> during development? <strong>No.</strong></li>
	<li>Would you like to set a robots.txt file to ban spiders? <strong>No.</strong></li>
</ul><p>Be sure to choose the <strong>Devise with Confirmable and Invitable modules</strong> option as it is required as a basis for the rails-prelaunch-signup app. You’ll also need the Bootstrap version of the SimpleForm gem.</p>
<p>After you create the application, switch to its folder to continue work directly in the application:</p>
<p>
  <code>$ cd rails-prelaunch-signup</code>
</p>
<h3>Edit the <span class="caps">README</span></h3>
<p>If you’re open sourcing the app on GitHub, please edit the <span class="caps">README</span> file to add a description of the app and your contact info. Changing the <span class="caps">README</span> is important if you’re using a clone of the example app. I’ve been mistaken (and contacted) as the author of apps that are copied from my example.</p>
<h2>Set Up Source Control (Git)</h2>
<p>When you generate the starter app, the template sets up a source control repository and makes an initial commit of the code.</p>
<p>At this point, you should create a GitHub repository for your project.</p>
<p>See detailed instructions for <a href="http://railsapps.github.com/rails-git.html">Using Git with Rails</a>.</p>
<h2>Set Up Gems</h2>
<h3>About Required Gems</h3>
<p>The application uses the following gems:</p>
<ul><li><a href="http://rubygems.org/gems/rails">rails</a></li>
	<li><a href="http://rubygems.org/gems/rspec-rails">rspec-rails</a></li>
	<li><a href="http://rubygems.org/gems/database_cleaner">database_cleaner</a></li>
	<li><a href="http://rubygems.org/gems/factory_girl_rails">factory_girl_rails</a></li>
	<li><a href="http://rubygems.org/gems/email_spec">email_spec</a></li>
	<li><a href="http://rubygems.org/gems/cucumber-rails">cucumber-rails</a></li>
	<li><a href="http://rubygems.org/gems/capybara">capybara</a></li>
	<li><a href="http://rubygems.org/gems/devise">devise</a></li>
</ul><h3>Set up Your Gemfile</h3>
<p>It’s a good idea to create a new gemset using rvm, the <a href="http://rvm.beginrescueend.com/">Ruby Version Manager</a>, as described in the article <a href="http://railsapps.github.com/installing-rails.html">Installing Rails</a>.</p>
<p>The starter app script sets up your gemfile.</p>
<p>See <a href="http://railsapps.github.com/rails-3-2-example-gemfile.html">Example Gemfiles for Rails 3.2</a>.</p>
<p>Open your <strong>Gemfile</strong> and you should see the following. Gem version numbers may differ:</p>
<p>
  <strong>Gemfile</strong>
</p>
<pre>
source 'https://rubygems.org'
gem 'rails', '3.2.3'
gem 'sqlite3'

group :assets do
  gem 'sass-rails',   '~&gt; 3.2.3'
  gem 'coffee-rails', '~&gt; 3.2.1'
  gem 'uglifier', '&gt;= 1.0.3'
end

gem 'jquery-rails'
gem "haml", "&gt;= 3.1.4"
gem "devise", "&gt;= 2.0.4"
gem "devise_invitable", "&gt;= 1.0.0"
gem "bootstrap-sass", "&gt;= 2.0.1"
gem "simple_form", "~&gt; 2.0"

group :development, :test do
  gem "rspec-rails", "&gt;= 2.8.1"
end

group :development do
  gem "haml-rails", "&gt;= 0.3.4"
end

group :test do
  gem "factory_girl_rails", "&gt;= 1.7.0"
  gem "email_spec", "&gt;= 1.2.1"
  gem "cucumber-rails", "&gt;= 1.3.0"
  gem "capybara", "&gt;= 1.1.2"
  gem "database_cleaner", "&gt;= 0.7.1"
  gem "launchy", "&gt;= 2.0.5"
end
</pre>
<p>Check for the <a href="http://rubygems.org/gems/rails">current version of Rails</a> and replace <code>gem 'rails', '3.2.3'</code> accordingly.</p>
<p><em>Note:</em> The RailsApps examples are generated with application templates created by the <a href="https://github.com/RailsApps/rails_apps_composer">Rails Apps Composer Gem</a>. For that reason, groups such as <code>:development</code> or <code>:test</code> are specified inline. You can reformat the Gemfiles to organize groups in an eye-pleasing block style. The functionality is the same.</p>
<h3>Install the Required Gems</h3>
<p>When you add a new gem to the Gemfile, you should run the <code>bundle install</code> command to install the required gems on your computer. In this case, the starter app script has already run the <code>bundle install</code> command.</p>
<p>You can check which gems are installed on your computer with:</p>
<p>
  <code>$ gem list --local</code>
</p>
<p>Keep in mind that you have installed these gems locally. When you deploy the app to another server, the same gems (and versions) must be available.</p>
<h2>Haml</h2>
<p>In this example, we’ll use Haml instead of the default “<span class="caps">ERB</span>” Rails template engine. The starter app script sets up Haml. You can see details about <a href="http://railsapps.github.com/rails-haml.html">adding Haml to Rails</a> with a discussion of the benefits and drawbacks in using Haml.</p>
<h2>RSpec</h2>
<p>The starter app script sets up RSpec for unit testing. Run <code>rake -T</code> to check that rake tasks for RSpec are available. You should be able to run <code>rake spec</code> to run all specs provided with the example app. To learn more about using RSpec, refer to <a href="http://www.pragprog.com/titles/achbd/the-rspec-book">The RSpec Book</a>.</p>
<h2>Cucumber</h2>
<p>The starter app script sets up Cucumber for specifications and acceptance testing. To learn more about using Cucumber, refer to <a href="http://pragprog.com/book/hwcuc/the-cucumber-book">The Cucumber Book</a> or the free introduction to Cucumber, <a href="http://cuke4ninja.com/">The Secret Ninja Cucumber Scrolls</a>.</p>
<p>You should be able to run <code>rake cucumber</code> (or more simply, <code>cucumber</code>) to run the Cucumber scenarios and steps provided with the example app. You can run a single Cucumber feature with a command such as:</p>
<pre>
$ bundle exec cucumber features/visitors/request_invitation.feature
</pre>
<p>The starter app script sets up the <strong>config/cucumber.yml</strong> file so it is not necessary to add <code>--require features</code> to the command to run a single Cucumber feature.</p>
<h2>Configure Email</h2>
<p>You must configure the app for your email account so your application can send email messages, for example, to acknowledge invitation requests or send welcome messages.</p>
<p>The starter app script sets up a default email configuration. You must add details about your email account.</p>
<h3>Configure ActionMailer</h3>
<p>ActionMailer is configured for development in the <strong>config/environments/development.rb</strong> file:</p>
<pre>
# ActionMailer Config
config.action_mailer.default_url_options = { :host =&gt; 'localhost:3000' }
config.action_mailer.delivery_method = :smtp
# change to false to prevent email from being sent during development
config.action_mailer.perform_deliveries = false
config.action_mailer.raise_delivery_errors = true
config.action_mailer.default :charset =&gt; "utf-8"
</pre>
<p>ActionMailer is configured for production in the <strong>config/environments/production.rb</strong> file:</p>
<pre>
config.action_mailer.default_url_options = { :host =&gt; 'example.com' }
# ActionMailer Config
# Setup for production - deliveries, no errors raised
config.action_mailer.delivery_method = :smtp
config.action_mailer.perform_deliveries = true
config.action_mailer.raise_delivery_errors = false
config.action_mailer.default :charset =&gt; "utf-8"
</pre>
<p>ActionMailer is configured for testing in  the <strong>config/environments/test.rb</strong> file:</p>
<pre>
# ActionMailer Config
config.action_mailer.default_url_options = { :host =&gt; 'example.com' }
</pre>
<p>This will set the example application to deliver email in production. Email messages are visible in the log file so there is no need to send email in development. The configuration above will raise delivery errors in development but not in production.</p>
<p>In development, <code>config.action_mailer.default_url_options</code> is set for a host at <code>localhost:3000</code> which will enable links in Devise confirmation email messages to work properly during development.</p>
<p>For testing, <code>config.action_mailer.default_url_options</code> is set for a host at <code>example.com</code>. Any value allows tests to run.</p>
<p>For production, you’ll need to change the <code>config.action_mailer.default_url_options</code> host option from <code>example.com</code> to your own domain.</p>
<h3>Use a Gmail account</h3>
<p>If you want to use a Gmail account to send email, you’ll need to modify the files <strong>config/environments/development.rb</strong> and <strong>config/environments/production.rb</strong>:</p>
<pre>
config.action_mailer.smtp_settings = {
  address: "smtp.gmail.com",
  port: 587,
  domain: "example.com",
  authentication: "plain",
  enable_starttls_auto: true,
  user_name: ENV["GMAIL_USERNAME"],
  password: ENV["GMAIL_PASSWORD"]
}
</pre>
<p>You can replace <code>ENV["GMAIL_USERNAME"]</code> and <code>ENV["GMAIL_PASSWORD"]</code> with your Gmail username and password. However, committing the file to a public GitHub repository will expose your secret password.</p>
<p>If you’re familiar with setting <a href="http://en.wikipedia.org/wiki/Environment_variable">Unix environment variables</a>, it’s advisable to leave <code>config.action_mailer.smtp_settings</code> unchanged and set your environment variables in the file that is read when starting an interactive shell (the <strong>~/.bashrc</strong> file for the bash shell). This will keep the password out of your repository.</p>
<p>Are you using a bash shell? Use <code>echo $SHELL</code> to find out. For a bash shell, edit the <strong>~/.bashrc</strong> file and add:</p>
<pre>
export GMAIL_USERNAME="myname@gmail.com"
export GMAIL_PASSWORD="secret*"
</pre>
<p>Open a new shell or restart your terminal application to continue.</p>
<h3>Configure Devise for Email</h3>
<p>Complete your email configuration by modifying</p>
<p>
  <strong>config/initializers/devise.rb</strong>
</p>
<p>and setting the <code>config.mailer_sender</code> option for the return email address for messages that Devise sends from the application.</p>
<h2>Set Up the Database</h2>
<h3>Create a Default User</h3>
<p>You’ll want to set up a default user so you can test the app. The file <strong>db/seeds.rb</strong> already contains:</p>
<pre>
puts 'SETTING UP DEFAULT USER LOGIN'
user = User.create! :name =&gt; 'First User', :email =&gt; 'user@example.com', :password =&gt; 'please', :password_confirmation =&gt; 'please', :confirmed_at =&gt; DateTime.now
puts 'New user created: ' &lt;&lt; user.name
</pre>
<p>You can change the values for name, email, and password as you wish.</p>
<h3>Seed the Database</h3>
<p>The starter app script has already set up the database and added the default user.</p>
<p>If you change the default user’s name, email, or password you’ll need to reset the database:</p>
<pre>
$ bundle exec rake db:reset
</pre>
<p>If you need to, you can run <code>$ bundle exec rake db:reset</code> whenever you need to recreate the database.</p>
<h2>Test the Starter App</h2>
<p>You can check that the example app runs properly by entering the command</p>
<p>
  <code>$ rails server</code>
</p>
<p>To see your application in action, open a browser window and navigate to <a href="http://localhost:3000">http://localhost:3000/</a>. You should see the default user listed on the home page. When you click on the user’s name, you should be required to log in before seeing the user’s detail page.</p>
<p>Stop the server with Control-C.</p>
<h2>Modify the Starter App</h2>
<p>If you’ve tested the example app, you’ve seen that any user who logs in will see a list of all the users on the home page. That’s fine for an example app but it’s not what we want for production.</p>
<h3>Update the Home Page</h3>
<p>Replace the contents of the file <strong>app/views/home/index.html.haml</strong>:</p>
<pre>
%h3 Welcome
</pre>
<p>You can embellish the page as you wish.</p>
<p>Modify the file <strong>app/controllers/home_controller.rb</strong> to remove the <code>index</code> method:</p>
<pre>
class HomeController &lt; ApplicationController
end
</pre>
<h2>Feature: Request Invitation</h2>
<p>Now we’ll pick a user story and turn it into a specification that will guide implementation of a feature.</p>
<p>First we’ll get our git workflow set up for adding a new feature.</p>
<h3>Git Workflow</h3>
<p>When you are using git for version control, you can commit every time you save a file, even for the tiniest typo fixes. If only you will ever see your git commits, no one will care. But if you are working on a team, either commercially or as part of an open source project, you will drive your fellow programmers crazy if they try to follow your work and see such “granular” commits. Instead, get in the habit of creating a git branch each time you begin work to implement a feature. When your new feature is complete, merge the branch and “squash” the commits so your comrades see just one commit for the entire feature.</p>
<p>Create a new git branch for this feature:</p>
<pre>
$ git checkout -b request-invitation
</pre>
<p>The command creates a new branch named “request-invitation” and switches to it, analogous to copying all your files to a new directory and moving to work in the new directory (though that is not really what happens with git).</p>
<h3>User Story</h3>
<p>Here’s the user story we’ll specify and implement:</p>
<pre>
*Request Invitation*
As a visitor to the website
I want to request an invitation 
so I'll be notified when the site is launched
</pre>
<p>In many situations, your user story is all you need to guide you in coding the implementation. If you are both the product owner and a hands-on developer, you don’t need a written specification to implement a feature.</p>
<p>However, before you begin coding directly from a user story, consider the benefits of writing a specification:</p>
<ul><li>If you are part of a team you can use a specification to communicate what needs to be accomplished.</li>
	<li>Creating a specification can help us discover the functionality we need to implement.</li>
	<li>A specification will describe the functionality so we can discuss it with our business partners.</li>
	<li>Specifications can become the basis for acceptance testing or integration testing.</li>
</ul><p>For the purposes of this tutorial, acceptance tests and integration tests are synonymous. Acceptance tests demonstrate that developers have succeeded in implementing a specification. Integration tests assure you that your application runs as intended.</p>
<p>For these reasons, we want to create a detailed specification from this user story. We can use the specification to create an automated acceptance test so we know when the feature has been successfully implemented. Our acceptance tests can also serve as integration tests so we can continue to test the code as we build out or maintain the application.</p>
<p>We’ll use Cucumber to create our specification and acceptance tests. Not all developers use Cucumber. Some developers create integration tests using <a href="http://inancgumus.com/66712574">Capybara in combination with RSpec</a> as described in Ryan Bates’s <a href="http://railscasts.com/episodes/275-how-i-test">How I Test</a> Railscast. Cucumber is appropriate when a team includes nonprogrammers who are involved in defining product requirements or there is a need for a specification and acceptance tests to be maintained independently of implementation (for example, when implementation is outsourced). For this tutorial, we may all be programmers, but using Cucumber to create a specification helps to describe the features, organize the tutorial, and break the work into discrete tasks.</p>
<h3>Cucumber Scenario</h3>
<p>Now we begin writing our specification.</p>
<p>The <strong>features</strong> directory contains our Cucumber feature files. We can organize Cucumber feature files any way we wish by placing them in subdirectories. For this application, we’ll organize features by roles in subdirectories for “visitors” and “owner”. Create a subdirectory <strong>features/visitors</strong> and then create the following file:</p>
<p>
  <strong>features/visitors/request_invitation.feature</strong>
</p>
<pre>
Feature: Request Invitation
  As a visitor to the website
  I want to request an invitation 
  so I can be notified when the site is launched

  Background:
    Given I am not logged in

  Scenario: User views home page
    When I visit the home page
    Then I should see a button "Request Invitation"

  Scenario: User views invitation request form
    When I visit the home page
    And I click a button "Request Invitation"
    Then I should see a form with a field "Email"

  Scenario: User signs up with valid data
    When I request an invitation with valid user data
    Then I should see a message "Thank You"
    And my email address should be stored in the database
    And my account should be unconfirmed
    And I should receive an email with subject "Request Received"

  Scenario: User signs up with invalid email
    When I request an invitation with an invalid email
    Then I should see an invalid email message
</pre>
<p>This Cucumber feature file contains the specification needed to implement the user story “Request Invitation.”</p>
<p>It’s important to note that user stories don’t necessarily translate directly into Cucumber features. In this case, our first user story is easily transformed into a set of Cucumber scenarios that describe the user story completely. This is not always the case; don’t be concerned if <a href="http://blog.mattwynne.net/2010/10/22/features-user-stories/">Features != User Stories</a> as explained in Matt Wynne’s blog post.</p>
<h3>Cucumber Step Definitions</h3>
<p>Here we turn our specification into an automated acceptance test.</p>
<p>Cucumber scenarios can be read as plain English text. Alone, they serve as specifications. To create an acceptance test or integration test, we must write test code for each step in a scenario, called “step definitions.”</p>
<p>We’ll create step definitions for all the scenario steps in our “Feature: Request Invitation” file.</p>
<p>Create the following file:</p>
<p>
  <strong>features/step_definitions/visitor_steps.rb</strong>
</p>
<pre>
def new_user
  @user ||= { :email =&gt; "example@example.com",
    :password =&gt; "please", :password_confirmation =&gt; "please" }
end

def invitation_request user
  visit '/users/sign_up'
  fill_in "Email", :with =&gt; user[:email]
  click_button "Request Invitation"
end

When /^I visit the home page$/ do
    visit root_path
end

Then /^I should see a button "([^\"]*)"$/ do |arg1|
  page.should have_button (arg1)
end

When /^I click a button "([^"]*)"$/ do |arg1|
  click_button (arg1)
end

Then /^I should see a form with a field "([^"]*)"$/ do |arg1|
  page.should have_content (arg1)
end

Then /^I should see a message "([^\"]*)"$/ do |arg1|
  page.should have_content (arg1)
end

Then /^my email address should be stored in the database$/ do
  test_user = User.find_by_email("example@example.com")
  test_user.should respond_to(:email)
end

Then /^my account should be unconfirmed$/ do
  test_user = User.find_by_email("example@example.com")
  test_user.confirmed_at.should be_nil
end

When /^I request an invitation with valid user data$/ do
  invitation_request new_user
end

When /^I request an invitation with an invalid email$/ do
  user = new_user.merge(:email =&gt; "notanemail")
  invitation_request user
end
</pre>
<p>These step definitions accommodate all scenarios in our “Request Invitation” feature.</p>
<p>Cucumber uses all the step definitions in separate files in the <strong>features/step_definitions/</strong> directory so we can group the step definitions in as many files as we want.</p>
<p>Be sure you’ve set up the database for testing before running Cucumber:</p>
<pre>
$ bundle exec rake db:test:prepare
</pre>
<p>Then we can run our integration test with the following command:</p>
<pre>
$ bundle exec cucumber features/visitors/request_invitation.feature
</pre>
<p>The test should fail indicating that the home page has no button “Request Invitation.”</p>
<h3>Implement “Request Invitation” Form</h3>
<p>We begin implementing the actual application here.</p>
<p>The application’s home page doesn’t contain a “Request Invitation” form. We could add a sign-up form to the home page but we already have a sign-up form provided by Devise, our authentication gem. It’ll be easier to use the existing Devise mechanism.</p>
<p>We’ll modify the Devise form to use the <a href="https://github.com/plataformatec/simple_form">SimpleForm</a> gem. The SimpleForm gem lets us create forms that include tags that apply attractive Twitter Bootstrap form styles.</p>
<p>Take a look at the file <strong>app/views/devise/registrations/new.html.haml</strong>. We’ll modify it to make it a “Request Invitation” form.</p>
<ul><li>We’ll use <a href="https://github.com/plataformatec/simple_form">SimpleForm</a>.</li>
</ul><ul><li>We’ll change the heading from “Sign up” to “Request Invitation.”</li>
</ul><ul><li>We’ll remove the password fields and add a hidden input field with a placeholder password. Devise won’t let us create a new user without a password so we’ll trick Devise by providing a placeholder password.</li>
</ul><ul><li>We’ll remove the user name field (you could keep it if you wish).</li>
</ul><ul><li>We’ll change the submit button text from “Sign up” to “Request Invitation.”</li>
</ul><pre>
%h2 Request Invitation
= simple_form_for(resource, :as =&gt; resource_name, :url =&gt; registration_path(resource_name)) do |f|
  = devise_error_messages!
  = f.hidden_field :password, :value =&gt; 'please'
  = f.input :email, :placeholder =&gt; 'user@example.com'
  = f.submit "Request Invitation"
</pre>
<p>To make sure our acceptance tests continue to pass, we’ll need to make changes to the Cucumber step definition file <strong>features/step_definitions/user_steps.rb</strong>.</p>
<p>Replace the <code>sign_up</code> method with the following:</p>
<pre>
def sign_up
  delete_user
  visit '/users/sign_up'
  fill_in "Email", :with =&gt; @visitor[:email]
  click_button "Request Invitation"
  find_user
end
</pre>
<p>In the <strong>features/users/sign_up.feature</strong> file, remove the following:</p>
<pre>
Scenario: User signs up without password
  When I sign up without a password
  Then I should see a missing password message

Scenario: User signs up without password confirmation
  When I sign up without a password confirmation
  Then I should see a missing password confirmation message

Scenario: User signs up with mismatched password and confirmation
  When I sign up with a mismatched password confirmation
  Then I should see a mismatched password message
</pre>
<p>Finally, in the <strong>features/users/user_show.feature</strong> file, remove the following:</p>
<pre>
Scenario: Viewing users
  Given I exist as a user
  When I look at the list of users
  Then I should see my name
</pre>
<h3>Use Devise Registrations Page for the Home Page</h3>
<p>Examine the <strong>config/routes.rb</strong> file to learn how to use the Devise registrations page as our home page.</p>
<p>The starter app script sets up the <strong>config/routes.rb</strong> file with a route to the home page for authenticated users (those who have an account and are logged in) and the same route for all other users (those who have no account or are not logged in).</p>
<pre>
authenticated :user do
  root :to =&gt; 'home#index'
end

root :to =&gt; "home#index"
</pre>
<p>To make the Devise registrations page serve as the home page for users who have no account (or are not logged in),  replace the second <code>root :to =&gt; "home#index"</code> so you see this:</p>
<pre>
authenticated :user do
  root :to =&gt; 'home#index'
end
  
devise_scope :user do
  root :to =&gt; "devise/registrations#new"
end
</pre>
<p>With this change, casual visitors will see a “Request Invitation” form on the home page. And users who log in (presumably only an administrator or invited guests) will see the application “home#index” page.</p>
<h3>Create a “Thank You” Page</h3>
<p>For a simple “thank you” page, there’s no need to create a dynamic page with a controller and view. Instead, create a file for a static web page:</p>
<p>
  <strong>public/thankyou.html</strong>
</p>
<pre>
&lt;h1&gt;Thank You&lt;/h1&gt;
</pre>
<p>Obviously, you can embellish this page as needed.</p>
<h3>Redirect to “Thank You” Page After Successful Sign Up</h3>
<p>We want the visitor to see the “thank you” page after they request an invitation.</p>
<p>Override the Devise::RegistrationsController with a new controller. Create a file:</p>
<p>
  <strong>app/controllers/registrations_controller.rb</strong>
</p>
<pre>
class RegistrationsController &lt; Devise::RegistrationsController
  protected

  def after_inactive_sign_up_path_for(resource)
    '/thankyou.html'
  end
  
  def after_sign_up_path_for(resource)
    '/thankyou.html'
  end
  
end
</pre>
<p>When a visitor creates an account by requesting an invitation, Devise will call the <code>after_inactive_sign_up_path_for</code> method to redirect the visitor to the thank you page. In the future, after you launch the application and allow visitors to become active as soon as they create an account, you may use the <code>after_sign_up_path_for</code> to redirect the new user to the thank you page.</p>
<p>Modify <strong>config/routes.rb</strong> to use the new controller. Replace <code>devise_for :users</code> with:</p>
<pre>
devise_for :users, :controllers =&gt; { :registrations =&gt; "registrations" }
</pre>
<p>To make sure our acceptance tests continue to pass, we’ll need to make changes to the Cucumber step definition file <strong>features/step_definitions/user_steps.rb</strong>.</p>
<p>Replace the “successful sign up message” step definition content with “Thank You” (or anything else you’ve added to the thank you page):</p>
<pre>
Then /^I should see a successful sign up message$/ do
  page.should have_content "Thank You"
end
</pre>
<p>For more information, the Devise wiki explains <a href="https://github.com/plataformatec/devise/wiki/How-To%3a-Redirect-to-a-specific-page-on-successful-sign-up-%28registration%29/">How to Redirect to a Specific Page on Successful Sign Up</a>.</p>
<h3>Postpone Confirmation of New Accounts</h3>
<p>We want a visitor to create a new account when they request an invitation but we don’t want to confirm the email address and activate the account until we send an invitation.</p>
<p>There are several ways to implement this functionality. One approach is to add an “active” attribute to the User model and designate the account as “inactive” when it is created. Another approach is to simply revise the confirmation email to make it a simple “welcome” without the confirmation request but this would require re-implementing the confirmation request process later. The simplest approach is to postpone sending the user a request to confirm their email address, leaving the account unconfirmed until after we send the user an invitation.</p>
<p>We’ll modify the file <strong>app/models/user.rb</strong> to override methods supplied by Devise:</p>
<pre>
class User &lt; ActiveRecord::Base
  # Include default devise modules. Others available are:
  # :token_authenticatable, :encryptable, :confirmable, :lockable, :timeoutable and :omniauthable
  devise :invitable, :database_authenticatable, :registerable, :confirmable,
         :recoverable, :rememberable, :trackable, :validatable

  # Setup accessible (or protected) attributes for your model
  attr_accessible :name, :email, :password, :password_confirmation, :remember_me, :confirmed_at

  # override Devise method
  def confirmation_required?
    false
  end
  
  # override Devise method
  def active_for_authentication?
    confirmed? || confirmation_period_valid?
  end

end
</pre>
<p>Devise uses a conditional “after_create” callback to generate a confirmation token and send the confimation request email. It is only called if <code>confirmation_required?</code> returns true. By indicating that “confirmation is not required,” no confimation email will be sent when the account is created.</p>
<p>When we tell Devise that “confirmation is not required,” Devise will assume that any new account is “active_for_authentication.” We don’t want that, so we override the <code>active_for_authentication?</code> method so that unconfirmed accounts are not active.</p>
<h3>Send a Welcome Email</h3>
<p>Ordinarily, when the Devise Confirmable module is configured and a new user requests an invitation, Devise will send an email with instructions to confirm the account. We’ve changed this behavior so the user doesn’t get a confirmation request. However, we still want to send a welcome email.</p>
<p>We didn’t revise the confirmation email to make it a welcome message. That might seem simpler but it would require us to re-implement the confirmation request process later. Instead we’ll add send an email welcome message using a new ActionMailer method when the account is created.</p>
<p>Generate a mailer with views and a spec:</p>
<pre>
$ rails generate mailer UserMailer
</pre>
<p>Modify the file <strong>spec/mailers/user_mailer_spec.rb</strong> to create a test:</p>
<pre>
require "spec_helper"

describe UserMailer do
  before(:all) do
    @user = FactoryGirl.create(:user, email: "example@example.com")
    @email = UserMailer.welcome_email(@user).deliver
  end

  it "should be delivered to the email address provided" do
    @email.should deliver_to("example@example.com")
  end

  it "should contain the correct message in the mail body" do
    @email.should have_body_text(/Welcome/)
  end

  it "should have the correct subject" do
    @email.should have_subject(/Request Received/)
  end

end
</pre>
<p>Add a <code>welcome_email</code> method to the mailer by editing the file <strong>app/mailers/user_mailer.rb</strong>:</p>
<pre>
class UserMailer &lt; ActionMailer::Base
  default :from =&gt; "notifications@example.com"

  def welcome_email(user)
    mail(:to =&gt; user.email, :subject =&gt; "Invitation Request Received")
  end
end
</pre>
<p>Create a mailer view by creating a file <strong>app/views/user_mailer/welcome_email.html.erb</strong>. This will be the template used for the email, formatted in <span class="caps">HTML</span>:</p>
<pre>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Welcome&lt;/h1&gt;
    &lt;p&gt;
      We have received your request for an invitation to example.com.
    &lt;/p&gt;
    &lt;p&gt;
      We'll contact you when we launch.
    &lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>It is a good idea to make a text-only version for this message. Create a file  <strong>app/views/user_mailer/welcome_email.text.erb</strong>:</p>
<pre>
Welcome!

We have received your request for an invitation to example.com.
 
We'll contact you when we launch.
</pre>
<p>When you call the mailer method, ActionMailer will detect the two templates (text and <span class="caps">HTML</span>) and automatically generate a multipart/alternative email.</p>
<p>Now we’ll wire up the User model to send the welcome message when an account is created.</p>
<p>Modify the file <strong>app/models/user.rb</strong> to add the <code>send_welcome_email</code> method:</p>
<pre>
class User &lt; ActiveRecord::Base
  # Include default devise modules. Others available are:
  # :token_authenticatable, :encryptable, :confirmable, :lockable, :timeoutable and :omniauthable
  devise :invitable, :database_authenticatable, :registerable, :confirmable,
         :recoverable, :rememberable, :trackable, :validatable

  # Setup accessible (or protected) attributes for your model
  attr_accessible :name, :email, :password, :password_confirmation, :remember_me, :confirmed_at

  after_create :send_welcome_email

  # override Devise method
  def confirmation_required?
    false
  end
  
  # override Devise method
  def active_for_authentication?
    confirmed? || confirmation_period_valid?
  end
  
  private

  def send_welcome_email
    UserMailer.welcome_email(self).deliver
  end

end
</pre>
<p>Now the visitor will get a welcome email when they request an invitation.</p>
<h3>Tweak the User Interface</h3>
<p>The required functionality is largely complete. But there are a few small changes to make.</p>
<p>If the user visits the sign-in page immediately after requesting an invitation, they may see this flash message:</p>
<p>“A message with a confirmation link has been sent to your email address. Please open the link to activate your account.”</p>
<p>In the file <strong>config/locales/devise.en.yml</strong>, find this message:</p>
<pre>
signed_up_but_unconfirmed: 'A message with a confirmation link has been sent to your email address. Please open the link to activate your account.'
</pre>
<p>Replace it with this:</p>
<pre>
signed_up_but_unconfirmed: 'Your invitation request has been received. You will receive an invitation when we launch.'
</pre>
<p>Be careful not to use an apostrophe or single quote in the message unless you surround the text with double quotes.</p>
<p>If the visitor attempts to sign in, they will see this message:</p>
<p>“You have to confirm your account before continuing.”</p>
<p>In the file <strong>config/locales/devise.en.yml</strong>, find this message:</p>
<pre>
unconfirmed: 'You have to confirm your account before continuing.'
</pre>
<p>Replace it with this:</p>
<pre>
unconfirmed: 'Your account is not active.'
</pre>
<p>To make sure our acceptance tests continue to pass, we’ll need to make changes to the Cucumber step definition file <strong>features/step_definitions/user_steps.rb</strong>.</p>
<p>Replace the “unconfirmed account message” step definition:</p>
<pre>
Then /^I see an unconfirmed account message$/ do
  page.should have_content "Your account is not active."
end
</pre>
<p>The user will also see links on the sign-in page: “Didn’t receive confirmation instructions?” and “Forgot your password?”.</p>
<p>Remove these links by removing the following from the file <strong>app/views/devise/_links.erb</strong>:</p>
<pre>
&lt;%- if devise_mapping.confirmable? &amp;&amp; controller_name != 'confirmations' %&gt;
  &lt;%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %&gt;&lt;br /&gt;
&lt;% end -%&gt;

&lt;%- if devise_mapping.recoverable? &amp;&amp; controller_name != 'passwords' %&gt;
  &lt;%= link_to "Forgot your password?", new_password_path(resource_name) %&gt;&lt;br /&gt;
&lt;% end -%&gt;
</pre>
<p>You may want to restore these links when you launch.</p>
<p><em>Note:</em> Or make the links conditional?</p>
<h3>Test the Implemention of the “Request Invitation” Feature</h3>
<p>Run the integration test with the following command:</p>
<pre>
$ bundle exec cucumber features/visitors/request_invitation.feature
</pre>
<p>The test should succeed.</p>
<p>Evaluating only the functionality, the feature is complete. In the next section, we’ll improve the look and feel of the feature.</p>
<h3>Git Workflow</h3>
<p>Since the new feature is complete, merge the working branch to “master” and squash the commits so you have just one commit for the entire feature:</p>
<pre>
$ git checkout master
$ git merge --squash request-invitation
$ git commit -am "implement 'Request Invitation' feature"
</pre>
<p>You can delete the working branch when you’re done:</p>
<pre>
$ git branch -d request-invitation
</pre>
<h2>Improving the Design: Modal Window</h2>
<p>The functionality of the “Request Invitation” feature is complete. Let’s improve the look and feel of the feature.</p>
<h3>Git Workflow</h3>
<p>Create a new git branch for the changes you’ll make to the page design:</p>
<pre>
$ git checkout -b work-in-progress
</pre>
<p>The command creates a new branch named “work-in-progress” and switches to it.</p>
<h3>Add a Modal Window</h3>
<p>It’d be nice for the “request invitation” page to include some “romance copy” to convince the visitor of the value of the site. The “call to action” could be a big button that says, “Request Invitation,” which opens a modal window and invites the visitor to enter an email address and click a submit button.</p>
<p>Twitter Bootstrap gives us everything we need to implement this in a few lines of code.</p>
<p>Open the file <strong>app/views/devise/registrations/new.html.haml</strong> and replace the contents with this new code:</p>
<pre>
#request-invite.modal{:style =&gt; "display: none;"}
  = simple_form_for resource, :as =&gt; resource_name, :url =&gt; registration_path(resource_name) , :html =&gt; {:class =&gt; 'form-horizontal' } do |f|
    .modal-header
      %a.close{"data-dismiss" =&gt; "modal"} ×
      %h3 Request Invitation
    .modal-body
      = f.error_notification
      = f.hidden_field :password, :value =&gt; 'please'
      = f.input :email, :placeholder =&gt; 'user@example.com'
    .modal-footer
      = f.submit "Request Invitation", :class =&gt; "btn.btn-success", :id =&gt; 'invitation_button'
      %a.btn{"data-dismiss" =&gt; "modal", :href =&gt; "#"} Close
#romance-copy{:style =&gt; "text-align: center; margin-top: 80px"}
  %h2 Want in?
#call-to-action{:style =&gt; "text-align: center; margin-top: 80px"}
  %a.btn.btn-primary.btn-large{"data-toggle" =&gt; "modal", :href =&gt; "#request-invite"} Request invite
</pre>
<p>The revised view code includes <span class="caps">CSS</span> classes from Twitter Bootstrap that implement the modal window and apply style to the buttons. You’ll note that our code includes some simple style rules to position the romance copy and the call-to-action button. These styles could be moved to an external stylesheet; for now, it’s easier to include them in the view file.</p>
<h3>Display Errors</h3>
<p>Displaying the “request invitation” form inside a modal window is a nice touch but it creates a problem: Form validation error messages are hidden. See for yourself. Open the modal window, leave the email field blank and click the submit button. You’ll see the home page without any indication that there was a problem. Click the home page “Request Invite” button again and you’ll see there is an error message in the modal window.</p>
<p>Our first option is to force the form to be displayed when errors are present. We can do this by modifying the first line like this:</p>
<pre>
#request-invite.modal{:style =&gt; "display: #{@user.errors.any? ? 'block' : 'none'};"}
</pre>
<p>When you test this by submitting a form without an email address, you’ll see the form appears with error messages. However, we don’t see the full effect of the modal window because the page is not opaque as it should be with the modal window. We can keep the modified code, but we really need some jQuery code to trigger the modal window when an error message is present.</p>
<p>Add the following to the file <strong>app/assets/javascripts/application.js</strong>:</p>
<pre>
// display validation errors for the "request invitation" form
$('document').ready(function() {
  if ($('#error_explanation').length &gt; 0) {
    $("#request-invite").modal('toggle');
  }
})
</pre>
<p>When the <code>#error_explanation</code> element contains text, the page will refresh and the modal window will be displayed properly.</p>
<h2>Improving the Design: Adding <span class="caps">AJAX</span></h2>
<p>
  <em>Thank you to <a href="http://andreapavoni.com">Andrea Pavoni</a> for the <span class="caps">AJAX</span> implementation.</em>
</p>
<p>We’ve improved the appearance of the “invitation request” page by adding a modal window using Twitter Bootstrap. We can make further improvements. As implemented, the page refreshes with a roundtrip to the server when we submit the form successfully (or get an an error). Our app will look more sophisticated if we use <span class="caps">AJAX</span> techniques to update the page without a page refresh.</p>
<p>We don’t need changes to the “invitation request” page. We’ll add a partial to provide a “thank you” message. Add a file <strong>app/views/devise/registrations/_thankyou.html.haml</strong>:</p>
<pre>
%h1 Thank you
#request-invite.modal{:style =&gt; "display: 'block';"}
  .modal-header
    %a.close{"data-dismiss" =&gt; "modal"} ×
    %h3 Thank you!
  .modal-body
    %p We have received your request for an invitation to example.com.
    %p We'll contact you when we launch.
</pre>
<p>Next, add some JavaScript to the file <strong>app/assets/javascripts/application.js</strong>. This will trigger an <span class="caps">AJAX</span> submission action when the “request invitation” button is clicked and update the <code>#request-invite</code> div on completion.</p>
<pre>
$('document').ready(function() {
  
  // display validation errors for the "request invitation" form
  if ($('#error_explanation').length &gt; 0) {
    $("#request-invite").modal('toggle');
  }
  
  // use AJAX to submit the "request invitation" form
  $('#invitation_button').live('click', function() {
    var email = $('form #user_email').val();
    var password = $('form #user_password').val();
    var dataString = 'user[email]='+ email + '&amp;user[password]=' + password;
    $.ajax({
      type: "POST",
      url: "/users",
      data: dataString,
      success: function(data) {
        $('#request-invite').html(data);
      }
    });
    return false;
  });
  
})
</pre>
<p>Finally, we need to override the <code>create</code> method in the Devise registration controller to render the “thank you” partial. Modify the file <strong>app/controllers/registrations_controller.rb</strong>:</p>
<pre>
class RegistrationsController &lt; Devise::RegistrationsController

  # ovverride #create to respond to AJAX with a partial
  def create
    build_resource

    if resource.save
      if resource.active_for_authentication?
        sign_in(resource_name, resource)
        (render(:partial =&gt; 'thankyou', :layout =&gt; false) &amp;&amp; return)  if request.xhr?
        respond_with resource, :location =&gt; after_sign_up_path_for(resource)
      else
        expire_session_data_after_sign_in!
        (render(:partial =&gt; 'thankyou', :layout =&gt; false) &amp;&amp; return)  if request.xhr?
        respond_with resource, :location =&gt; after_inactive_sign_up_path_for(resource)
      end
    else
      clean_up_passwords resource
      render :action =&gt; :new, :layout =&gt; !request.xhr?
    end
  end

  protected

  def after_inactive_sign_up_path_for(resource)
    '/thankyou.html'
  end

  def after_sign_up_path_for(resource)
    '/thankyou.html'
  end

end
</pre>
<p>To make sure our acceptance tests continue to pass, we’ll need to make a tweak to the Cucumber step definition file <strong>features/step_definitions/user_steps.rb</strong>.</p>
<p>Replace the “unconfirmed account message” step definition to accommodate the SimpleForm output:</p>
<pre>
Then /^I should see an invalid email message$/ do
  page.should have_content "Emailis invalid"
end
</pre>
<p>Now we can say we have built a “Web 2.0” application. When the visitor submits the form, the modal window changes to display a “thank you” message (or an error message) without a page refresh.</p>
<h3>Git Workflow</h3>
<p>Merge the working branch to “master”:</p>
<pre>
$ git checkout master
$ git merge --squash work-in-progress
$ git commit -am "improve design for 'Request Invitation' feature"
$ git branch -d work-in-progress
</pre>
<h2>Feature: View Progress</h2>
<p>Now we’ll implement the next user story.</p>
<p>First we’ll set up our git workflow so we can add a new feature.</p>
<h3>Git Workflow</h3>
<p>Create a new git branch for this feature:</p>
<pre>
$ git checkout -b view-progress
</pre>
<p>The command creates a new branch named “view-progress.”</p>
<h3>User Story</h3>
<p>Here’s the user story we’ll specify and implement:</p>
<pre>
*View Progress*
As the owner of the site
I want to know how many visitors have requested invitations
so I can know if my offer is popular
</pre>
<h3>Cucumber Scenario</h3>
<p>Now we begin writing our specification.</p>
<p>Create a subdirectory <strong>features/admins</strong> and then create the following file:</p>
<p>
  <strong>features/admins/view_progress.feature</strong>
</p>
<pre>
Feature: View Progress
  As the owner of the site
  I want to know how many visitors have requested invitations
  so I can know if my offer is popular

  Scenario: Administrator views list of users
    Given I am logged in as an administrator
    When I visit the users page
    Then I should see a list of users

  Scenario: User cannot view list of users
    Given I am logged in
    When I visit the users page
    Then I should see an access denied message
</pre>
<p>This Cucumber feature file contains the specification needed to implement the user story “View Progress.”</p>
<h3>Cucumber Step Definitions</h3>
<p>Turn the specification into an automated acceptance test. Create step definitions for all the scenario steps in our “Feature: View Progress” file.</p>
<p>Create the following file:</p>
<p>
  <strong>features/step_definitions/admin_steps.rb</strong>
</p>
<pre>
Given /^I am logged in as an administrator$/ do
  pending # express the regexp above with the code you wish you had
end

When /^I visit the users page$/ do
  pending # express the regexp above with the code you wish you had
end

Then /^I should see a list of users$/ do
  pending # express the regexp above with the code you wish you had
end

Then /^I should see an access denied message$/ do
  pending # express the regexp above with the code you wish you had
end
</pre>
<h3>Add a Users Page</h3>
<p>We’ll need a page that shows a list of users.</p>
<p>Create a file <strong>app/views/users/index.html.haml</strong>:</p>
<pre>
%h2 Users
- @users.each do |user|
  %br/
  #{link_to user.email, user} signed up #{user.created_at.to_date}
</pre>
<p>Modify the controller file <strong>app/controllers/users_controller.rb</strong>:</p>
<pre>
class UsersController &lt; ApplicationController
  before_filter :authenticate_user!

  def index
    @users = User.all
  end

  def show
    @user = User.find(params[:id])

  end
end
</pre>
<p>Modify <strong>config/routes.rb</strong> to add the new page:</p>
<pre>
resources :users, :only =&gt; [:show, :index]
</pre>
<p>Now you can visit the page <a href="http://localhost:3000/users">http://localhost:3000/users</a> to see a list of users.</p>
<p>Of course, as implemented, any authenticated user can visit that page and see a list of all the users.</p>
<h3>Add Authorization using CanCan</h3>
<p>To view a list of users, not only should a user be authenticated but he or she should be in a role that is authorized to view the users page. Devise provides authentication, a system to securely identify users, making sure the user is really who he represents himself to be. We need to add a system for authorization to determine if an authenticated user should have access to secured resources. Taking a look at the Rails Authorization category on <a href="https://www.ruby-toolbox.com/categories/rails_authorization">The Ruby Toolbox</a> site, you’ll see Cancan is by far the most popular gem used to implement authorization. The author, Ryan Bates, offers a <a href="http://railscasts.com/episodes/192-authorization-with-cancan">RailsCast on Authorization with CanCan</a> to show how to use it.</p>
<p>(more to come)</p>
    </div><!-- class="content" -->
    
    <div class="comments">
      <div class="content wikistyle gollum">
        <h2>Comments</h2>
      </div>
      <p>Is this helpful? Please "like" below. Question or suggestion? Please add a comment below. Got a correction or addition? You can edit this page <a href="https://github.com/RailsApps/railsapps.github.com/wiki/_pages">on the wiki</a> or create a <a href="https://github.com/RailsApps/railsapps.github.com/issues">GitHub issue</a> to alert me.</p>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'railsapps'; // required: replace example with your forum shortname

          // The following are highly recommended additional parameters.
          // var disqus_identifier = 'tutorial-rails-prelaunch-signup.html';
          // var disqus_url = 'http://railsapps.github.com/tutorial-rails-prelaunch-signup.html';

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div><!-- class="comments" -->

    <div class="footer row">
      <div class="span4">
        <h3>Credits</h3>
        <p><a href="http://danielkehoe.com/">Daniel Kehoe</a> initiated the <a href="http://railsapps.github.com/">RailsApps Project</a>. Thanks to <a href="http://tigrish.com/">Christopher Dell</a> for design contributions.</p> 
      </div>
    
      <div class="span4">
        <h3>Contributions</h3>
        <p>Corrections? Additions? You can edit this page <a href="https://github.com/RailsApps/railsapps.github.com/wiki/_pages">on the wiki</a>.</p>
      </div>

      <div class="span4">
        <h3>Last edit</h3>
        <p>by <b>Daniel Kehoe</b>, 2012-04-23 14:14:51</p>
      </div>
    </div>

  </div>
            
  </body>
</html>
